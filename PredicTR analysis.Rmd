---
title: "PredicTR analysis"
output: html_document
date: "2025-04-30"
---

## Install/load packages and import data

```{r packages, include=FALSE}

library(survival)
library(survcomp)
library(MASS)
library(rms)
library(polspline)
library(knitr)
library(readxl)
if (!require("pacman")) install.packages("pacman")
library(pacman)
pacman::p_load(survival,
               Hmisc,
               pec,
               timeROC,
               riskRegression,
               rms,
               knitr,
               kableExtra,
               tidyverse)

options(show.signif.stars = FALSE)  # display statistical intelligence
```

#Load data
```{r setup, include=FALSE}
#Load data

data <- read_excel("~/Downloads/Lauren/Med school/Research/PredicTR/Predictor cleaned dataset ( recieved Syed Haider 2.3.17 merged_data) +Manchester gender info.xls")

#str(data)
training <-  data[data$set == "Training", ]
val <- data[data$set == "Validation", ]

all_vars <- c("BCL2", "COX2", "CyclinD1", "EGFRext", "HIF1alpha", "PLK1","Survivin", 
              "p16", "HPVISHHR","TILS", "Gender","Age at Diagnosis", "Surgery", 
              "RT", "CT", "T", "N", "Smoking status")
cont_vars <- c("BCL2", "COX2", "CyclinD1", "EGFRext", "HIF1alpha", "PLK1","Survivin")

biomarkers <- c("BCL2", "COX2", "CyclinD1", "EGFRext", "HPVISHHR", "p16", "PLK1", "Survivin","TILS")

#Set which vars to select and keep them
predictr_data <- subset(data, select = c(all_vars, "t.os", "Outcome", "set"))

predictr_data_dx_date <- subset(data, select = c(all_vars, "t.os", "Outcome", "set", "Diagnostic Biopsy Date"))
#str(predictr_data_dx_date)

## Numeric conversion except gender and set.
to_numeric <- function(data, vars) {
  for (col in vars) {
    if (col!="Gender" & col!="set"){
      if (is.factor(data[[col]]) || is.character(data[[col]])) {
            data[[col]] <- as.character(data[[col]])
            data[[col]][data[[col]] == "NA"] <- NA
            data[[col]] <- as.numeric(data[[col]])
          }
    }

    
  }

#  #scale the continuous vars, "cont_vars" then z-transform
#  for (col in cont_vars) {
#    data[[col]] <- as.numeric(as.character(data[[col]]))
#    data[[col]] <- scale(data[[col]]/30)[,1]
# }
 
  # Dichotomise p16
#  data$p16 <- as.numeric(as.character(data$p16))
#  data$p16 <- factor(ifelse(data$p16 >= 140, 1, 0))


  return(data)
} 


#Convert everything except Gender to numeric
predictr_data <- to_numeric(predictr_data, c(all_vars, "Outcome", "t.os"))
predictr_data_dx_date <- to_numeric(predictr_data_dx_date, c(all_vars, "Outcome", "t.os", "Diagnostic Biopsy Date"))
str(predictr_data)
str(predictr_data_dx_date)
# Convert "NA" to NA in Gender and set:
predictr_data$Gender[predictr_data$Gender == "NA"] <- NA
predictr_data$set[predictr_data$set == "NA"] <- NA

predictr_data_dx_date$Gender[predictr_data_dx_date$Gender == "NA"] <- NA
predictr_data_dx_date$set[predictr_data_dx_date$set == "NA"] <- NA


#Remove NAs (based on which variables?)
rm.na0 <- predictr_data[complete.cases(predictr_data), ]
#Gives 471 observations

rm.na1 <- predictr_data[!is.na(predictr_data$t.os), ]
# Gives 835 observations — these will be the ones we work with for the analysis.

#rm.na2 has removed data with missing time to OS and outcome (i.e. censored)
rm.na2 <- predictr_data[!is.na(predictr_data$t.os) & !is.na(predictr_data$Outcome), ]
# Gives 809 observations

# colSums(is.na(rm.na2_dx_date))
# Here, 'Age at Diagnosis' has 2 NAs: maybe that's another required var?

rm.na1_dx_date <- predictr_data_dx_date[!is.na(predictr_data_dx_date$t.os), ]
# Gives 835 obs - these will be the pts used for analysis with validation dataset.

#Convert continuous variables to z scores, factor p16, HR-HPV DNA, TILs, age, gender, T-category, N-category, smoking status, surgery, RT, CT (using lowest category as baseline group). Need to make sure everything is already numeric

preprocess <- function(data, cont_vars) {
#scale the continuous vars, "cont_vars" then z-transform
  for (col in c(cont_vars)) {
    data[[col]] <- as.numeric(as.character(data[[col]]))
    data[[col]] <- scale(data[[col]]/30)[,1]
 }
 
  # Dichotomise p16
  data$p16_binary <- factor(ifelse(data$p16 >= 140, 1, 0))
  # Dichotomise age
  data$`Age at Diagnosis` <- factor(ifelse(data$`Age at Diagnosis`>= 50, 1, 0))
  # Factor variables:
  data$HPVISHHR <- factor(data$HPVISHHR)
  data$TILS <- factor(data$TILS)
  data$T <- factor(data$T)
  data$N <- factor(data$N)
  data$`Smoking status` <- factor(data$`Smoking status`)
  data$Surgery <- factor(data$Surgery)
  data$RT <- factor(data$RT)
  data$CT <- factor(data$CT)
  data$Gender <- factor(data$Gender)
  
  return(data)
} 
#Only use training_data (from data_scaled) for survival analysis
data_scaled <- preprocess(rm.na1, cont_vars)

data_scaled_dx_date <- preprocess(rm.na1_dx_date, cont_vars)
str(data_scaled)
str(data_scaled_dx_date)

#Split into training and validation
training_data <- data_scaled[data_scaled$set == "Training", ]
#n=530
training_data_dx_date <- data_scaled_dx_date[data_scaled_dx_date$set == "Training",]
#n=528

val_data <-data_scaled[data_scaled$set == "Validation", ]
#n=305
val_data_dx_date <- data_scaled_dx_date[data_scaled_dx_date$set == "Validation",]
#n=305


# Create the datasets at specific timepoints: 3y
temp <- survSplit(Surv(t.os, Outcome) ~ ., data = val_data_dx_date, cut = 3, episode = "epoch")
test_val_3 <- subset(temp, epoch == 1)  # Censored at 3 years

# Create the datasets at specific timepoints: 5y
temp <- survSplit(Surv(t.os, Outcome) ~ ., data = val_data_dx_date, cut = 5, episode = "epoch")
test_val_5 <- subset(temp, epoch == 1)  # Censored at 3 years


str(training_data)
str(training_data_dx_date)



```

```{r}




```

## Table S4

```{r}
summary(predictr_data[biomarkers])
```
## Table S5
n are different - +/- 1 or 2 observations in almost all columns
```{r}
#n column
summary(training_data)[]
nrow(training_data_dx_date)
summary(training_data_dx_date)[]
col_n <- nrow(training_data_dx_date) - colSums(is.na(training_data_dx_date))
col_n
#Make sure names agree
names(training_data)
names(col_n)[names(col_n) == "Age at Diagnosis"] <- "Age.at.Diagnosis"
names(col_n)[names(col_n) == "Smoking status"] <- "Smoking.status"
names(col_n)
```

##Univariable Cox
```{r Table S5}
# Function for univariable Cox
univariable_cox <- function(data, vars, n_obs) {
  results <- lapply(vars, function(var) {

    
    formula <- as.formula(paste("Surv(t.os, Outcome) ~", var))
    model <- coxph(formula, data = data)
    coef_summary <- summary(model)$coefficients
    return(data.frame(Variable = var, 
                      Coefficient = coef_summary[, "coef"],
                      Lower = coef_summary[, "coef"] - 1.96 * coef_summary[, "se(coef)"],
                      Upper = coef_summary[, "coef"] + 1.96 * coef_summary[, "se(coef)"],
                      P = coef_summary[, "Pr(>|z|)"],
                      n = n_obs[[var]]
                      ))
  })
  results_df <- bind_rows(results)
  # Adjust p-values using Benjamini & Hochberg method
  results_df$Q <- p.adjust(results_df$P, method = "BH")
  return(bind_rows(results_df))
}

colnames(training_data)[colnames(training_data) == 'Age at Diagnosis'] <- 'Age.at.Diagnosis'
colnames(training_data)[colnames(training_data) == 'Smoking status'] <- 'Smoking.status'

all_vars1 <- c("BCL2", "COX2", "CyclinD1", "EGFRext", "HIF1alpha", "PLK1","Survivin", 
              "p16_binary", "HPVISHHR","TILS", "Gender","Age.at.Diagnosis", "Surgery", 
              "RT", "CT", "T", "N", "Smoking.status")

# Summary of key columns
str(training_data[, c("t.os", "Outcome", all_vars1)])
sapply(training_data[, c("t.os", "Outcome", all_vars1)], function(x) sum(is.na(x)))
#levels(training_data$Gender)
#F=1, M=2

# Univariable model results
print(univariable_cox(training_data, all_vars1, col_n))



```
## (NOT FOR THE PAPER) Backwards selection (Table S6): Biomarker-only original multivariable prognostic model
```{r Multivariable Cox PH}
# Function 5: Multivariable Cox with Backward Elimination (S6)
print_cox_model <- function(data, vars) {
  formula <- as.formula(paste("Surv(t.os, Outcome) ~", paste(vars, collapse = " + ")))
  full_model <- coxph(formula, data = data, x=T, y=T)
  k <- qchisq(0.25, 1, lower.tail = FALSE)  # ~1.323
  step_model <- step(full_model, direction = "backward", k = 2, trace = 1)
  #Extract coefficients
  coef_summary <- summary(step_model)$coefficients
  return(data.frame(Variable = rownames(coef_summary),
                    coef = coef_summary[, "coef"],
                    `exp(coef)` = coef_summary[, "exp(coef)"],
                    `se(coef)` = coef_summary[, "se(coef)"],
                    z = coef_summary[, "z"],
                    P = coef_summary[, "Pr(>|z|)"]))
}
biomarkers <- c("BCL2","COX2", "CyclinD1", "EGFRext", "HPVISHHR", "p16_binary", "PLK1", "Survivin", "TILS")
biomarkers_reduced <- c("p16_binary", "Survivin", "HPVISHHR", "TILS")
#biomarker_model <- fit_cox_model(training_data, biomarkers)
str(training_data[, c("t.os", "Outcome", biomarkers)])
sapply(training_data[, c("t.os", "Outcome", biomarkers)], function(x) sum(is.na(x)))
table(training_data$Outcome, useNA = "ifany")

colnames(training_data)[colnames(training_data) == 'Age at Diagnosis'] <- 'Age.at.Diagnosis'
colnames(training_data)[colnames(training_data) == 'Smoking status'] <- 'Smoking.status'

colnames(training_data_dx_date)[colnames(training_data_dx_date) == 'Age at Diagnosis'] <- 'Age.at.Diagnosis'
colnames(training_data_dx_date)[colnames(training_data_dx_date) == 'Smoking status'] <- 'Smoking.status'

str(training)
n_obs <- training_data %>%
  filter(!is.na(t.os)) %>%
  nrow()

print(n_obs)

# training on complete cases only (initial)
complete_training_data <- training_data_dx_date[complete.cases(training_data_dx_date[, c("t.os", "Outcome", all_vars1)]), ]

##INSERT IMPUTED DATASET HERE
##...
##...



# n= 259, want 266
print(print_cox_model(complete_training_data, biomarkers))
#Still get EGFRext, although it shouldn't be included

print(print_cox_model(complete_training_data, biomarkers_reduced))




```
# Kaplan-Meier curves:



## Model training and classification of risk groups (+Survivin)
```{r}
# Train the biomarker-only model
fit_cox_model <- function(data, vars) {
#  data <- data[complete.cases(data[, c("t.os", "Outcome", vars)]), ]
  cat("Training n =", nrow(data), "\n")
  
  formula <- as.formula(paste("Surv(t.os, Outcome) ~", paste(vars, collapse = " + ")))
  full_model <- coxph(formula, data = data, x=T, y=T)
#  k <- qchisq(0.25, 1, lower.tail = FALSE)  # 1.323
#  step_model <- step(full_model, direction = "backward", k = k, trace = 1)
  
  return(full_model)  # Return the model object
}

# survivin_model (Cox) : Surv(t.os, Outcome) ~ biomarkers_reduced, trained on complete cases only data (n=259)

survivin_model <- fit_cox_model(complete_training_data, biomarkers_reduced)


str(val_data_dx_date[, c("t.os", "Outcome", biomarkers_reduced)])
sapply(val_data_dx_date[, c("t.os", "Outcome", biomarkers_reduced)], function(x) sum(is.na(x)))


table(val_data_dx_date$Outcome, useNA = "ifany") #censored count: 12/305


colnames(val_data)[colnames(val_data) == 'Age at Diagnosis'] <- 'Age.at.Diagnosis'
colnames(val_data)[colnames(val_data) == 'Smoking status'] <- 'Smoking.status'

colnames(val_data_dx_date)[colnames(val_data_dx_date) == 'Age at Diagnosis'] <- 'Age.at.Diagnosis'
colnames(val_data_dx_date)[colnames(val_data_dx_date) == 'Smoking status'] <- 'Smoking.status'
colnames(val_data_dx_date)[colnames(val_data_dx_date) == 'Diagnostic Biopsy Date'] <- 'Diagnostic.Biopsy.Date'

#test_val_data: ensures all obs have complete biomarkers, diagnostic biopsy date, Outcome, and t.os.
# n = 218
test_val_data <- val_data_dx_date[complete.cases(val_data_dx_date[, c("t.os", "Diagnostic.Biopsy.Date", all_vars1)]), ]
test_val_data <- test_val_data %>%
  filter(!is.na(Outcome))
nrow(test_val_data)

# Creating 5-year-censored dataset, val_5, from test_val_data
temp <- survSplit(Surv(t.os, Outcome) ~ ., data = test_val_data, cut = 5, episode = "epoch")
val_5 <- subset(temp, epoch == 1)


# Creating 3-year-censored dataset, val_3, from test_val_data
temp <- survSplit(Surv(t.os, Outcome) ~ ., data = test_val_data, cut = 3, episode = "epoch")
val_3 <- subset(temp, epoch == 1)

# Creating 10-year-censored dataset, val_10, from test_val_data
temp <- survSplit(Surv(t.os, Outcome) ~ ., data = test_val_data, cut = 10, episode = "epoch")
val_10 <- subset(temp, epoch == 1)

# complete_val_data_dx_date: ensures all obs have t.os only
complete_val_data_dx_date <- val_data_dx_date[complete.cases(val_data_dx_date[, "t.os"]),]

nrow(complete_val_data_dx_date)
# n= 305

# Calculate risk scores based on training set:
complete_training_data$risk_score <- predict(survivin_model, complete_training_data, type = "lp")
summary(complete_training_data$risk_score)

# Median split — dichotomize into high- and low-risk groups
complete_training_data$risk_group <- ifelse(complete_training_data$risk_score > median(complete_training_data$risk_score, na.rm = TRUE), 1, 0)

sum(complete_training_data$risk_group)
risk_med_cutoff <- median(complete_training_data$risk_score)

# complete_val_data_dx_date (require t.os is complete): calculate and classify risk scores in validation cohort.

complete_val_data_dx_date$risk_score <- predict(survivin_model, complete_val_data_dx_date, type = "lp")
summary(complete_val_data_dx_date$risk_score)

complete_val_data_dx_date$risk_group <- ifelse(complete_val_data_dx_date$risk_score > risk_med_cutoff, 1, 0)

# test_val_data (require t.os and biomarkers are complete): calculate and classify risk scores in validation cohort:
test_val_data$risk_score <- predict(survivin_model, test_val_data, type = "lp")
summary(test_val_data$risk_score)

test_val_data$risk_group <- ifelse(test_val_data$risk_score > risk_med_cutoff, 1, 0)
# Number of patients in high-risk and low-risk groups (validation set):
table(test_val_data$risk_group)
# 95 assigned low-risk
# 117 assigned high-risk

# No. of events in each group:
complete_val_data_dx_date %>%
  select(Outcome, risk_group) %>%
  group_by(risk_group, Outcome) %>%
  summarise(n = n())

test_val_data %>%
  select(Outcome, risk_group) %>%
  group_by(risk_group, Outcome) %>%
  summarise(n = n())



## Try test_val_data, which ensures all obs have complete biomarkers and t.os. Try val_data_refined, which only ensures the 4 biomarkers are complete.

n_obs <- complete_val_data_dx_date %>%
  filter(if_all(all_of(biomarkers_reduced), ~ !is.na(.))) %>%
  nrow()

print(n_obs)



```

## Model training and classification of risk groups (-Survivin)
```{r}
new_model <- fit_cox_model(complete_training_data, c("p16_binary", "HPVISHHR", "TILS"))

# Calculate risk scores based on median of training set:
complete_training_data$risk_score_new <- predict(new_model, complete_training_data, type = "lp")
summary(complete_training_data$risk_score_new)
summary(complete_training_data$risk_score)

ggplot(complete_training_data, aes(x = risk_score)) +
  geom_histogram(aes(y = after_stat(density), fill = "Original"), alpha = 0.5, bins = 100) +
  geom_histogram(aes(x = risk_score_new, y = after_stat(density), fill = "New"), alpha = 0.5, bins = 100) +
  labs(title = "Histogram of Risk Scores",
       x = "Risk Score",
       y = "Density",
       fill = "Score Type") +
  theme_minimal()

risk_med_cutoff_new <- median(complete_training_data$risk_score_new)

hist(complete_training_data$risk_score_new, xlab = "Risk score",
     col = "grey", border = "black", breaks = 100)
# Using complete_val_data_dx_date (t.os is complete)
# calculate and classify risk scores in validation cohort:
complete_val_data_dx_date$risk_score_new <- predict(new_model, complete_val_data_dx_date, type = "lp")
summary(complete_val_data_dx_date$risk_score_new)
#plot
ggplot(complete_val_data_dx_date, aes(x = risk_score_new)) +
  geom_histogram(aes(y = after_stat(density), fill = "Original"), alpha = 0.5, bins = 100) +
  geom_histogram(aes(x = risk_score_new, y = after_stat(density), fill = "New"), alpha = 0.5, bins = 100) +
  labs(title = "Histogram of Risk Scores",
       x = "Risk Score",
       y = "Density",
       fill = "Score Type") +
  theme_minimal()

complete_val_data_dx_date$risk_group_new <- ifelse(complete_val_data_dx_date$risk_score_new > risk_med_cutoff_new, 1, 0)
# Number of patients in high-risk and low-risk groups (validation set):
table(complete_val_data_dx_date$risk_group_new)

# No. of events in each group:
complete_val_data_dx_date %>%
  select(Outcome, risk_group_new) %>%
  group_by(risk_group_new, Outcome) %>%
  summarise(n = n())


# 3-year and 5-year OS by risk group:

surv_obj <- Surv(complete_val_data_dx_date$t.os, complete_val_data_dx_date$Outcome)
surv_fit_new <- survfit(surv_obj ~ risk_group_new, data = complete_val_data_dx_date)
summary(surv_fit_new, times = seq(0,5)*1)


# calculate and classify risk scores in validation cohort:
complete_val_data_dx_date$risk_score_new <- predict(new_model, complete_val_data_dx_date, type = "lp")
summary(complete_val_data_dx_date$risk_score_new)
#plot
ggplot(complete_val_data_dx_date, aes(x = risk_score_new)) +
  geom_histogram(aes(y = after_stat(density), fill = "Original"), alpha = 0.5, bins = 100) +
  geom_histogram(aes(x = risk_score_new, y = after_stat(density), fill = "New"), alpha = 0.5, bins = 100) +
  labs(title = "Histogram of Risk Scores",
       x = "Risk Score",
       y = "Density",
       fill = "Score Type") +
  theme_minimal()


# Using test_val_data (requires t.os and biomarkers are complete)

test_val_data$risk_score_new <- predict(new_model, test_val_data, type = "lp")
summary(test_val_data$risk_score_new)
summary(complete_val_data_dx_date$risk_score_new)

#no difference between test_val_data and complete_val_data_dx_date

# Classify into risk groups
test_val_data$risk_group_new <- ifelse(test_val_data$risk_score_new > risk_med_cutoff_new, 1, 0)


# Number of patients in high-risk and low-risk groups (validation set):
table(test_val_data$risk_group_new)

# No. of events in each group:
test_val_data %>%
  select(Outcome, risk_group_new) %>%
  group_by(risk_group_new, Outcome) %>%
  summarise(n = n())


# 3-year and 5-year OS by risk group:

surv_obj <- Surv(test_val_data$t.os, test_val_data$Outcome)
surv_fit_new <- survfit(surv_obj ~ risk_group_new, data = test_val_data)
summary(surv_fit_new, times = seq(0,5)*1)


```

# classification changes in the new model
```{r}
library(dplyr)

#Validation data
table(test_val_data$risk_group_new)

test_val_data %>%
  group_by(risk_group_new, risk_group) %>%
  summarise(n = n())  

#Training data
# Median split: dichotomize into high- and low-risk groups
complete_training_data$risk_group_new <- ifelse(complete_training_data$risk_score_new > median(complete_training_data$risk_score_new, na.rm = TRUE), 1, 0)

complete_training_data %>%
  group_by(risk_group_new, risk_group) %>%
  summarise(n = n())


```



## Plot, 4-biomarker model
```{r}
# Survival analysis
library(survival)

# Validation data

## From documentation: Surv() creates a survival object. Takes two arguments: time to event and event status: 1 for event and 0 for censoring.
## survfit() : Fits a survival curve using either a formula, of from a previously fitted Cox model.
## We will use "surv_obj ~ risk_group" as the formula for the K-M survival curves
#3-year and 5-year OS
surv_obj <- Surv(test_val_data$t.os, test_val_data$Outcome)
surv_fit0 <- survfit(surv_obj ~ risk_group, data = test_val_data)
summary(surv_fit0, times = seq(0,5)*1)

# Log-rank test to conduct between-group significance -> log-rank p-value
survdiff(surv_obj ~ risk_group, data = test_val_data)

library(survminer)
library(ggsurvfit)

# Plot with ggsurvplot

table(test_val_data$risk_group)
summary(test_val_data)

surv_fit <- survfit2(Surv(t.os, Outcome) ~ risk_group, data = test_val_data, type = "kaplan-meier") %>%
  ggsurvfit() +
  add_risktable() +
  add_confidence_interval() +
  guides(fill = "none") +
  add_pvalue(caption = "Log-rank {p.value}") + #show log-rank p-value
  scale_x_continuous(
    limits = c(0,5), # Truncates at 5y
    breaks = seq(0,5, by =1 ), # 1-year ticks
    name = "Time (years)"
  ) +
  scale_y_continuous(name = "Survival Probability") +
  scale_color_manual(
    values = c("red", "blue"),
    name = "Risk Group",
    labels = c("Low Risk", "High Risk")
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
    panel.background = element_blank(),      # optional: remove grey background
    panel.grid = element_blank()             # optional: remove gridlines
  ) +
  annotate(
    "text", 
    x = 0,  # adjust X location as needed
    y = 0.25,  # adjust Y location as needed
    label = "atop(HR == 4.24 ~ '(2.49–7.23)', italic(p) == 7.3 %*% 10^-9)",  parse = TRUE, 
    hjust = 0,
    size = 4
  )


surv_fit


# Training data curve 

surv_fit_t <- survfit2(Surv(t.os, Outcome) ~ risk_group, data = complete_training_data, type = "kaplan-meier") %>%
  ggsurvfit() +
  add_censor_mark(shape = "|", size = 2) +
  add_risktable() +  
  add_censor_mark(shape = "|", size = 2) +
  add_confidence_interval() +
  guides(fill = "none") +
  add_pvalue(caption = "Log-rank {p.value}") + #show log-rank p-value
  scale_x_continuous(
    limits = c(0,5), # Truncates at 5y
    breaks = seq(0,5, by =1 ), # 1-year ticks
    name = "Time (years)"
  ) +
  scale_y_continuous(name = "Survival Probability") +
  scale_color_manual(
    values = c("red", "blue"),
    name = "Risk Group",
    labels = c("Low Risk", "High Risk")
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
    panel.background = element_blank(),      # optional: remove grey background
    panel.grid = element_blank()             # optional: remove gridlines
  ) +
  annotate(
    "text", 
    x = 0,  # adjust X location as needed
    y = 0.15,  # adjust Y location as needed
    label = "atop(paste('HR = 8.20 (4.19–16.05)'), italic(p) == 2.6 %*% 10^-13)",  parse = TRUE, 
    hjust = 0,
    size = 4
  )

surv_fit_t

```

#Plots, 3-biomarker model
```{r}

# Validation data curve 

library(ggsurvfit)
surv_fit_new <- survfit2(Surv(t.os, Outcome) ~ risk_group_new, data = test_val_data, type = "kaplan-meier") %>%
  ggsurvfit() +
  add_risktable() +
  add_censor_mark(shape = "|", size = 2) +
  add_confidence_interval() +
  guides(fill = "none") +
  add_pvalue(caption = "Log-rank {p.value}") + #show log-rank p-value
  scale_x_continuous(
    limits = c(0,5), # Truncates at 5y
    breaks = seq(0,5, by =1 ), # 1-year ticks
    name = "Time (years)"
  ) +
  scale_y_continuous(name = "Survival Probability") +
  scale_color_manual(
    values = c("red", "blue"),
    name = "Risk Group",
    labels = c("Low Risk", "High Risk")
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
    panel.background = element_blank(),      # optional: remove grey background
    panel.grid = element_blank()             # optional: remove gridlines
  )+
  annotate(
    "text", 
    x = 0,  # adjust X location as needed
    y = 0.25,  # adjust Y location as needed
    label = "atop(HR == 3.82 ~ '(2.41–6.08)', italic(p) == 9.6 %*% 10^-10)",  parse = TRUE, 
    hjust = 0,
    size = 4
  )

surv_fit_new


# Training data curve 

surv_fit_new_t <- survfit2(Surv(t.os, Outcome) ~ risk_group_new, data = complete_training_data, type = "kaplan-meier") %>%
  ggsurvfit() +
  add_risktable() +
  add_censor_mark(shape = "|", size = 2) +
  add_confidence_interval() +
  guides(fill = "none") +
  add_pvalue(caption = "Log-rank {p.value}") + #show log-rank p-value
  scale_x_continuous(
    limits = c(0,5), # Truncates at 5y
    breaks = seq(0,5, by =1 ), # 1-year ticks
    name = "Time (years)"
  ) +
  scale_y_continuous(name = "Survival Probability") +
  scale_color_manual(
    values = c("red", "blue"),
    name = "Risk Group",
    labels = c("Low Risk", "High Risk")
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
    panel.background = element_blank(),      # optional: remove grey background
    panel.grid = element_blank()             # optional: remove gridlines
  ) +
  annotate(
    "text", 
    x = 0,  # adjust X location as needed
    y = 0.15,  # adjust Y location as needed
    label = "atop(HR == 5.69 ~ '(3.38–9.58)', italic(p) == 1.7 %*% 10^-13)",  parse = TRUE, 
    hjust = 0,
    size = 4
  )


surv_fit_new_t
```





## Table S11 (includes C-index, sensitivity, PPV, NPV)
```{r}
# Train the 4-biomarker model

fit_cox_model <- function(data, vars) {
#  data <- data[complete.cases(data[, c("t.os", "Outcome", vars)]), ]
  cat("Training n =", nrow(data), "\n")
  
  formula <- as.formula(paste("Surv(t.os, Outcome) ~", paste(vars, collapse = " + ")))
  full_model <- coxph(formula, data = data, x=T, y=T)
#  k <- qchisq(0.25, 1, lower.tail = FALSE)  # 1.323
#  step_model <- step(full_model, direction = "backward", k = k, trace = 1)
  
  return(full_model)  # Return the model object
}

survivin_model <- fit_cox_model(complete_training_data, biomarkers_reduced)


str(test_val_data[, c("t.os", "Outcome", biomarkers_reduced)])
sapply(test_val_data[, c("t.os", "Outcome", biomarkers_reduced)], function(x) sum(is.na(x)))
table(test_val_data$Outcome, useNA = "ifany")
# no NAs. 127 -> 0, 85 -> 1

# colnames(val_data)[colnames(val_data) == 'Age at Diagnosis'] <- 'Age.at.Diagnosis'
# colnames(val_data)[colnames(val_data) == 'Smoking status'] <- 'Smoking.status'
# 
# colnames(val_data_dx_date)[colnames(val_data_dx_date) == 'Age at Diagnosis'] <- 'Age.at.Diagnosis'
# colnames(val_data_dx_date)[colnames(val_data_dx_date) == 'Smoking status'] <- 'Smoking.status'
# colnames(val_data_dx_date)[colnames(val_data_dx_date) == 'Diagnostic Biopsy Date'] <- 'Diagnostic.Biopsy.Date'
# 
# complete_val_data_dx_date <- val_data_dx_date[complete.cases(val_data_dx_date[, c("t.os", "Outcome", "Diagnostic.Biopsy.Date", all_vars1)]), ]
# 
# nrow(complete_val_data_dx_date)
# # n= 212

test_val_data$risk_score <- predict(survivin_model, newdata = test_val_data, type = "lp")
summary(test_val_data$risk_score)

complete_training_data$risk_score <- predict(survivin_model, newdata = complete_training_data, type = "lp")

# Median split: dichotomize into high- and low-risk groups
test_val_data$risk_group <- ifelse(test_val_data$risk_score > median(complete_training_data$risk_score, na.rm = TRUE), 1, 0)
```


```{r Old Survival analysis}
# Survival analysis
library(survival)
surv_obj <- Surv(test_val_data$t.os, test_val_data$Outcome)
surv_fit <- survfit(surv_obj ~ risk_group, data = test_val_data)
summary(surv_fit)
survdiff(surv_obj ~ risk_group, data = test_val_data)  # Log-rank test

plot(surv_fit, col = c("blue", "red"), main = "Survival by Risk Group", xlab = "Time (t.os)", ylab = "Survival Probability", xlim = c(0,5))
legend("topright", c("Low Risk", "High Risk"), col = c("blue", "red"), lty = 1)

library(survminer)

# Fit survival model
surv_fit <- survfit(Surv(t.os, Outcome) ~ risk_group, data = complete_val_data_dx_date, type = "kaplan-meier")

# Plot with ggsurvplot
ggsurvplot(
  surv_fit,
  data = test_val_data,
  xlim = c(0, 5),                   # restrict x-axis to 5 years
  break.time.by = 1,
  xlab = "Time (years)",
  ylab = "Survival Probability",
 #surv.median.line = "hv",         # optional: add horizontal/vertical median lines
  pval = TRUE,                     # show log-rank p-value
  conf.int = TRUE,                 # add confidence interval
  risk.table = TRUE,              # add risk table below
  tables.y.text = FALSE,
  censor = TRUE,                   # mark censoring (default: TRUE)
  mark.time = TRUE,                # show tick marks at event times
  palette = c("blue", "red"),      # customise colours
  legend.title = "Risk Group",
  legend.labs = c("Low Risk", "High Risk"),
  fontsize = 3
)

surv_fit
```



# Cox model, 4-biomarker model
```{r}
# Cox model for HR, CI, p-value for validation data — 4-biomarker model

cox_model <- coxph(Surv(t.os, Outcome) ~ risk_group, data = test_val_data, x=T, y=T)
cox_summary <- summary(cox_model)
print(cox_summary$coefficients)  # See row/col names
coef <- cox_summary$coefficients["risk_group", "coef"]
hr <- cox_summary$coefficients["risk_group", "exp(coef)"]
se <- cox_summary$coefficients["risk_group", "se(coef)"]
ci_lower <- exp(coef - 1.96 * se)
ci_upper <- exp(coef + 1.96 * se)
p_value <- cox_summary$coefficients["risk_group", "Pr(>|z|)"]

# Output
cat("HR (1 vs. 0):", hr, "\n") #HR (1 vs. 0): 4.24
cat("95% CI:", ci_lower, "-", ci_upper, "\n") #95% CI: 2.49 - 7.23 
cat("P-value:", p_value, "\n") #P-value: p<0.001 (1.1e-7) 

#More succinct way to find HR using val data

library(gtsummary)

coxph(Surv(t.os, Outcome) ~ risk_group, data = test_val_data) %>%
  tbl_regression(exp=TRUE)
#returns a table


# HR using val data, 4-biomarker

hr1 <- hazard.ratio(x=test_val_data$risk_group, surv.time = test_val_data$t.os, surv.event = test_val_data$Outcome)
hr1[c(1,4,5,6)]

#HR using training data:

complete_training_data$risk_score <- predict(survivin_model, newdata = complete_training_data, type = "lp")

# Median split: dichotomize into high- and low-risk groups
complete_training_data$risk_group <- ifelse(complete_training_data$risk_score > median(complete_training_data$risk_score, na.rm = TRUE), 1, 0)

hr_train <- hazard.ratio(x=complete_training_data$risk_group, surv.time = complete_training_data$t.os, surv.event = complete_training_data$Outcome)

# HR (95%CI), p-val
hr_train[c(1,4,5,6)]
# Get 8.20 (4.19-16.05)

cox_risk_analysis <- function(data, time_col = "t.os", event_col = "Outcome", group_col = "risk_group", factor = FALSE) {
  # Handle risk_group
  if (factor) {
    data[[group_col]] <- factor(data[[group_col]], levels = c("Low", "High"))
    coef_name <- paste0(group_col, "High")
  } else {
    data[[group_col]] <- as.numeric(data[[group_col]])
    coef_name <- group_col
  }
  
  # Cox model
  formula <- as.formula(paste("Surv(", time_col, ",", event_col, ") ~", group_col))
  cox_model <- coxph(formula, data = data, x=T, y=T)
  cox_summary <- summary(cox_model)  
  
  # Extract results
  coef <- cox_summary$coefficients[coef_name, "coef"]
  hr <- cox_summary$coefficients[coef_name, "exp(coef)"]
  se <- cox_summary$coefficients[coef_name, "se(coef)"]
  ci_lower <- exp(coef - 1.96 * se)
  ci_upper <- exp(coef + 1.96 * se)
  p_value <- cox_summary$coefficients[coef_name, "Pr(>|z|)"]
  # Output
  label <- if (factor) "High vs. Low" else "1 vs. 0"
  cat("HR (", label, "): ", hr, "\n", sep = "")
  cat("95% CI: ", ci_lower, " - ", ci_upper, "\n", sep = "")
  cat("P-value: ", p_value, "\n", sep = "")
  
  # Return
  return(list(hr = hr, ci_lower = ci_lower, ci_upper = ci_upper, p_value = p_value, 
              coefficients = cox_summary$coefficients))
}

results_val <- cox_risk_analysis(test_val_data, time_col = "t.os", 
                                   event_col = "Outcome", group_col = "risk_group", 
                                   factor = FALSE)



```

# Create dataset for censoring up to 5 years
```{r}
test_val_data %>%
  filter(t.os <= 5) %>%
  nrow(.)


```



# Cox model, 3-biomarker model
```{r}
# Cox model for HR, CI, p-value for validation data — 3-biomarker model

#Risk scores
test_val_data$risk_score_new <- predict(new_model, newdata = test_val_data, type = "lp")

# Median split: dichotomize into high- and low-risk groups
test_val_data$risk_group_new <- ifelse(test_val_data$risk_score_new > median(complete_training_data$risk_score_new, na.rm = TRUE), 1, 0)


cox_model_new <- coxph(Surv(t.os, Outcome) ~ risk_group_new, data = test_val_data, x=T, y=T)

cox_summary_new <- summary(cox_model_new)
print(cox_summary_new$coefficients)  # See row/col names
coef_new <- cox_summary_new$coefficients["risk_group_new", "coef"]
hr_new <- cox_summary_new$coefficients["risk_group_new", "exp(coef)"]
se_new <- cox_summary_new$coefficients["risk_group_new", "se(coef)"]
ci_lower_new <- exp(coef_new - 1.96 * se_new)
ci_upper_new <- exp(coef_new + 1.96 * se_new)
p_value_new <- cox_summary_new$coefficients["risk_group_new", "Pr(>|z|)"]

# Output
cat("HR (1 vs. 0):", hr_new, "\n") #HR (1 vs. 0): 3.82
cat("95% CI:", ci_lower_new, "-", ci_upper_new, "\n") #95% CI: 2.41 - 6.07
cat("P-value:", p_value_new, "\n") #P-value: p<0.001 (1.3e-8) 

# For a table of HR, 95% CI using val data 

library(gtsummary)

coxph(Surv(t.os, Outcome) ~ risk_group_new, data = test_val_data) %>%
  tbl_regression(exp=TRUE)


hr1_new <- hazard.ratio(x=test_val_data$risk_group_new, surv.time = test_val_data$t.os, surv.event = test_val_data$Outcome)
hr1_new[c(1,4,5,6)]


hr_train_new <- hazard.ratio(x=complete_training_data$risk_group_new, surv.time = complete_training_data$t.os, surv.event = complete_training_data$Outcome)

# HR (95%CI), p-val
hr_train_new[c(1,4,5,6)]
hr_train[c(1,4,5,6)]
```


# HR comparisons (not essential; see note)
```{r}
# NOTE: COMPARING HR IS NOT THE BEST WAY TO COMPARE MODELS. HRs tell you how quickly disease progresses on average but not discrimination.
# Comparing HRs between high- and low-risk groups in validation data, 4-biomarker model vs. 3-biomarker model
hr.comp(hr1, hr1_new)
# And for training data, 4-biomarker model vs. 3-biomarker model:
hr.comp(hr_train, hr_train_new)

```


# Discrimination Measures: C-index
```{r}
library(pacman)
pacman::p_load(survival,
               Hmisc,
               riskRegression,
               timeROC)


summary(test_val_data$t.os)
# Distribution of time to OS 
tOS_hist <- hist(test_val_data$t.os)

#Add linear predictor for 4-biomarker model (lp4) and 3-biomarker model (lp3) to the validation set
test_val_data$lp4 <- predict(survivin_model, test_val_data)
test_val_data$lp3 <- predict(new_model, test_val_data)


# FOUR-BIOMARKER (ORIGINAL) CONCORDANCE, VALIDATION DATA
# 3-year C-index:
## Harrell's C
cindex_3yr <- val_3 %>%
  { concordance(Surv(t.os, Outcome) ~ lp4, data = ., reverse = TRUE) }
cindex_3yr
## Uno's C
uno_cindex_3yr <- val_3 %>%  # keep events or censored before 3 years
  { concordance(Surv(t.os, Outcome) ~ lp4, data = ., reverse = TRUE,
                           timewt = "n/G2") }
uno_cindex_3yr
# 5-year C-index:
## Harrell's C
cindex_5yr <- val_5 %>%
  { concordance(Surv(t.os, Outcome) ~ lp4, data = ., reverse = TRUE) }
cindex_5yr
## Uno's C
uno_cindex_5yr <- val_5 %>%
  { concordance(Surv(t.os, Outcome) ~ lp4, data = ., reverse = TRUE,
                           timewt = "n/G2") }
uno_cindex_5yr


# 10-year C-index:
## Harrell's C
cindex_10yr <- val_10 %>%
  { concordance(Surv(t.os, Outcome) ~ lp4, data = ., reverse = TRUE) }
cindex_10yr

## Uno's C
uno_cindex_10yr <- val_10 %>%
  { concordance(Surv(t.os, Outcome) ~ lp4, data = ., reverse = TRUE,
                           timewt = "n/G2") }
uno_cindex_10yr

## Validation data: calculation of C-index for 3-biomarker model

# THREE-BIOMARKER (NEW) CONCORDANCE, VALIDATION DATA
# 3-year C-index:
## Harrell's C
cindex_3yr_new <- val_3 %>%
  { concordance(Surv(t.os, Outcome) ~ lp3, data = ., reverse = TRUE) }

## Uno's C
uno_cindex_3yr_new <- val_3 %>%
  { concordance(Surv(t.os, Outcome) ~ lp3, data = ., reverse = TRUE,
                           timewt = "n/G2") }

# 5-year C-index:
## Harrell's C

cindex_5yr_new <- val_5 %>%  
  { concordance(Surv(t.os, Outcome) ~ lp3, data = ., reverse = TRUE) }


## Uno's C
uno_cindex_5yr_new <- val_5 %>%
  { concordance(Surv(t.os, Outcome) ~ lp3, data = ., reverse = TRUE,
                           timewt = "n/G2") }

# 10-year C-index:
## Harrell's C
cindex_10yr_new <- val_10 %>%
  { concordance(Surv(t.os, Outcome) ~ lp3, data = ., reverse = TRUE) }

## Uno's C
uno_cindex_10yr_new <- val_10 %>%
  { concordance(Surv(t.os, Outcome) ~ lp3, data = ., reverse = TRUE,
                           timewt = "n/G2") }
```


# Concordance indices
```{r, concordance_table,warning=FALSE,echo=FALSE}

alpha <- 0.05

temp <- c(
  # Original model
  ## 3-year Harrell's C
  cindex_3yr$concordance,
  cindex_3yr$concordance - 
    qnorm(1 - alpha/2) * sqrt(cindex_3yr$var),
  cindex_3yr$concordance + 
    qnorm(1 - alpha/2) * sqrt(cindex_3yr$var),
  ## 5-year Harrell's C
  cindex_5yr$concordance,
  cindex_5yr$concordance - 
    qnorm(1 - alpha/2) * sqrt(cindex_5yr$var),
  cindex_5yr$concordance + 
    qnorm(1 - alpha/2) * sqrt(cindex_5yr$var),
  ## 10-year Harrell's C
  cindex_10yr$concordance,
  cindex_10yr$concordance - 
    qnorm(1 - alpha/2) * sqrt(cindex_10yr$var),
  cindex_10yr$concordance + 
    qnorm(1 - alpha/2) * sqrt(cindex_10yr$var),
  
  ## 3-year Uno's C
  uno_cindex_3yr$concordance,
  uno_cindex_3yr$concordance - 
    qnorm(1 - alpha/2) * sqrt(uno_cindex_3yr$var),
  uno_cindex_3yr$concordance + 
    qnorm(1 - alpha/2) * sqrt(uno_cindex_3yr$var),
  ## 5-year Uno's C
  uno_cindex_5yr$concordance,
  uno_cindex_5yr$concordance - 
    qnorm(1 - alpha/2) * sqrt(uno_cindex_5yr$var),
  uno_cindex_5yr$concordance + 
    qnorm(1 - alpha/2) * sqrt(uno_cindex_5yr$var),
  ## 10-year Uno's C
  uno_cindex_10yr$concordance,
  uno_cindex_10yr$concordance - 
    qnorm(1 - alpha/2) * sqrt(uno_cindex_10yr$var),
  uno_cindex_10yr$concordance + 
    qnorm(1 - alpha/2) * sqrt(uno_cindex_10yr$var),
  
  # New model
  ## 3-year Harrell's C
  cindex_3yr_new$concordance,
  cindex_3yr_new$concordance - 
    qnorm(1 - alpha/2) * sqrt(cindex_3yr_new$var),
  cindex_3yr_new$concordance + 
    qnorm(1 - alpha/2) * sqrt(cindex_3yr_new$var),
  ## 5-year Harrell's C
  cindex_5yr_new$concordance,
  cindex_5yr_new$concordance - 
    qnorm(1 - alpha/2) * sqrt(cindex_5yr_new$var),
  cindex_5yr_new$concordance + 
    qnorm(1 - alpha/2) * sqrt(cindex_5yr_new$var),
  ## 10-year Harrell's C
  cindex_10yr_new$concordance,
  cindex_10yr_new$concordance - 
    qnorm(1 - alpha/2) * sqrt(cindex_10yr_new$var),
  cindex_10yr_new$concordance + 
    qnorm(1 - alpha/2) * sqrt(cindex_10yr_new$var),
  
  ## 3-year Uno's C
  uno_cindex_3yr_new$concordance,
  uno_cindex_3yr_new$concordance - 
    qnorm(1 - alpha/2) * sqrt(uno_cindex_3yr_new$var),
  uno_cindex_3yr_new$concordance + 
    qnorm(1 - alpha/2) * sqrt(uno_cindex_3yr_new$var),
  ## 5-year Uno's C
  uno_cindex_5yr_new$concordance,
  uno_cindex_5yr_new$concordance - 
    qnorm(1 - alpha/2) * sqrt(uno_cindex_5yr_new$var),
  uno_cindex_5yr_new$concordance + 
    qnorm(1 - alpha/2) * sqrt(uno_cindex_5yr_new$var),
  ## 10-year Uno's C
  uno_cindex_10yr_new$concordance,
  uno_cindex_10yr_new$concordance - 
    qnorm(1 - alpha/2) * sqrt(uno_cindex_10yr_new$var),
  uno_cindex_10yr_new$concordance + 
    qnorm(1 - alpha/2) * sqrt(uno_cindex_10yr_new$var)


)


res_C  <- matrix(temp, 
                nrow = 2, 
                ncol = 18, 
                byrow = TRUE,
                dimnames = list(
  c("Four-biomarker model", 
    "Three-biomarker model"),
  
  c("Harrell - 3y", "Lower .95", "Upper .95",
    "Harrell - 5y", "Lower .95", "Upper .95",
    "Harrell - 10y", "Lower .95", "Upper .95",
    "Uno - 3y", "Lower .95", "Upper .95",
    "Uno - 5y", "Lower .95", "Upper .95",
    "Uno - 10y", "Lower .95", "Upper .95"
    ))
)

res_C <- round(res_C, 3) # Digit
res_C
```


# Time-dependent discrimination (AUROC at 3 and 5 years), 3- and 4-biomarker model
```{r AUROC calculations for both models}
library(timeROC)

# This function returns the Uno AUC with 95% CI at *timepoint* years, rounded to k decimal places, taking either lp4 or lp3 for old and new models respectively.

get_uno_auc <- function(data, timepoint, alpha = 0.05, k = 3, marker_var = "lp4") {
  roc_result <- timeROC::timeROC(
    T = data$t.os,
    delta = data$Outcome,
    marker = data[[marker_var]],
    cause = 1,
    weighting = "marginal",
    times = timepoint,
    iid = TRUE
  )
  
  auc <- unname(roc_result$AUC[paste0("t=", timepoint)])
  sd <- roc_result$inference$vect_sd_1[paste0("t=", timepoint)]
  
  res <- c(setNames(auc, paste0("Uno ", timepoint, "-year AUC")),
    "Lower .95" = auc - qnorm(1 - alpha / 2) * sd,
    "Upper .95" = auc + qnorm(1 - alpha / 2) * sd
  )
  
  round(res, k)
}
# 4-biomarker +survivin model
# 3 years
get_uno_auc(test_val_data, timepoint = 2.99)
# 5 years
get_uno_auc(test_val_data, timepoint = 4.99)

# 3-biomarker -survivin model

# 3 years
get_uno_auc(test_val_data, timepoint = 2.99, marker_var = "lp3")
# 5 years
get_uno_auc(test_val_data, timepoint = 4.99, marker_var = "lp3")



```
# Mean calibration
observed/expected ratio for fixed time point of 5 years, estimated with Observed:Expected ratio.
Observed -> the complement of the Kaplan-Meier curve at t=5y. 
Expected -> average predicted risk of the event at 5y. 
```{r Mean calibration}

# -survivin 3-biomarker model
library(pacman)
pacman::p_load(survival,
               Hmisc,
               riskRegression)
t_horizon <- 5
# Observed
obj <- summary(survfit(
  Surv(t.os, Outcome) ~ 1, 
  data = test_val_data),
  times = t_horizon)

obs_t <- 1 - obj$surv

# Predicted risk 
test_val_data$pred_risk_5y <- riskRegression::predictRisk(new_model,
                                          newdata = test_val_data,
                                          times = t_horizon)
# Expected: mean risk at 5 y
exp_t <- mean(test_val_data$pred_risk_5y)

# Observed / Expected ratio
OE_t <- obs_t / exp_t

alpha <- .05
OE_summary <- c(
  "OE" = OE_t,
  "2.5 %" = OE_t * exp(-qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event)),
  "97.5 %" = OE_t * exp(+qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event))
)

OE_summary
cat(exp_t_survivin, exp_t)

#O:E ratio is 1.19 (0.95-1.49) for the -survivin 3-biomarker model at 5 years

#+survivin 4-biomarker model

# Predicted risk 
test_val_data$pred_risk_5y_survivin <- riskRegression::predictRisk(survivin_model,
                                          newdata = test_val_data,
                                          times = t_horizon)
# Expected: mean risk at 5 y
exp_t_survivin <- mean(test_val_data$pred_risk_5y_survivin)

# Observed / Expected ratio
OE_t_survivin <- obs_t / exp_t_survivin

alpha <- .05
OE_summary_survivin <- c(
  "OE" = OE_t_survivin,
  "2.5 %" = OE_t_survivin * exp(-qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event)),
  "97.5 %" = OE_t_survivin * exp(+qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event))
)

OE_summary_survivin

#O:E ratio is 1.15 (0.92-1.44) for the +survivin 4-biomarker model

```

# Weak Calibration
Calibration slope for a fixed time point (5y)

```{r Weak calibration}

# Fit the 4-biomarker +survivin model (training data):
survivin_cal_fit <- coxph(Surv(t.os, Outcome) ~ p16_binary + Survivin + HPVISHHR + TILS,
  data = complete_training_data, 
  x = T, 
  y = T)

# Fit the 3-biomarker -survivin model:
new_cal_fit  <- update(survivin_cal_fit, . ~ . -Survivin)

# 4-biomarker model:
# Add linear predictor in the validation set
val_5$lp_survivin_calibration <- predict(survivin_cal_fit, newdata = val_5)

gval_survivin <- coxph(Surv(t.os, Outcome) ~ lp_survivin_calibration, data = val_5)

survivin_calslope_summary <- c(
  "calibration slope" = gval_survivin$coef,
  "2.5 %"  = gval_survivin$coef - qnorm(1 - alpha / 2) * sqrt(gval_survivin$var),
  "97.5 %" = gval_survivin$coef + qnorm(1 - alpha / 2) * sqrt(gval_survivin$var)
)

survivin_calslope_summary

# 3-biomarker model:
# Add linear predictor in the validation set
val_5$lp_new_calibration <- predict(new_cal_fit, newdata = val_5)

gval_new <- coxph(Surv(t.os, Outcome) ~ lp_new_calibration, data = val_5)

new_calslope_summary <- c(
  "calibration slope" = gval_new$coef,
  "2.5 %"  = gval_new$coef - qnorm(1 - alpha / 2) * sqrt(gval_new$var),
  "97.5 %" = gval_new$coef + qnorm(1 - alpha / 2) * sqrt(gval_new$var)
)

new_calslope_summary
survivin_calslope_summary


```


# Moderate Calibration - assess whether observed event rate matches the predicted risk within subgroups of patients with similar predicted risk levels
Moderate calibration at fixed time point can be assessed using flexible calibration curve, complemented with ICI, E50, E90 as suggested by Austin et al.

+ Calibration curve is a graphical representation of moderate calibration. It shows:  
      
  + on the *x-axis* the predicted survival (or risk) probabilities at a fixed time horizon (e.g. at 5 years);  
      
  + on the *y-axis* the observed survival (or risk) probabilities at a fixed time horizon (e.g. at 5 years);  
      
  + The 45-degree line indicates perfect calibration. 
      Points below the 45-degree line indicate that the model overestimates the observed risk. 
      If points are above the 45-degree line, the model underestimate the observed risk;
      The observed probabilities estimated by the Kaplan-Meier curves (in case of survival) or by the complementary of the Kaplan-Meier curves (in case of risk) are represented in terms of percentiles of the predicted survival (risk) probabilities.
      
+ Integrated Calibration Index (ICI) is the weighted mean of absolute difference between smoothed observed proportions and predicted probabilities in which observations are weighted by the empirical density function of the predicted probabilities;  

+ E50 and E90 denote the median and the 90th percentile of the absolute differences between observed and predicted probabilities of the outcome at time *t*;  


```{r Moderate calibration, +survivin}
# Flexible calibration curve, with ICI, E50, E90

if (!require("pacman")) install.packages("pacman")
library(pacman)
pacman::p_load(survival,
               Hmisc,
               rms)

# +survivin model
sfit <- coxph(Surv(t.os, Outcome) ~ p16_binary + Survivin + HPVISHHR + TILS,
  data = complete_training_data, 
  x = T, 
  y = T)


# curve:
val_5$pred_survivin <- riskRegression::predictRisk(sfit, 
                         newdata = val_5, 
                         times = 5)

val_5$pred_survivin.cll <- log(-log(1 - val_5$pred_survivin))


# Estimate actual risk
vcal_s <- rms::cph(Surv(t.os, Outcome) ~ rcs(pred_survivin.cll, 3),
                 x = T,
                 y = T,
                 surv = T,
                 data = val_5
) 

dat_cal_s <- cbind.data.frame(
  "obs" = 1 - rms::survest(vcal_s,
                           times = 5,
                           newdata = val_5)$surv,
  
  "lower" = 1 - rms::survest(vcal_s,
                             times = 5,
                             newdata = val_5)$upper,
  
  "upper" = 1 - rms::survest(vcal_s,
                             times = 5,
                             newdata = val_5)$lower,
  "pred" = val_5$pred_survivin
)

dat_cal_s <- dat_cal_s[order(dat_cal_s$pred), ]

# Numerical measures
absdiff_cph_s <- abs(dat_cal_s$pred - dat_cal_s$obs)

numsum_cph_s <- c(
  "ICI" = mean(absdiff_cph_s),
  setNames(quantile(absdiff_cph_s, c(0.5, 0.9)), c("E50", "E90")),
  "Emax" = max(absdiff_cph_s)
)
numsum_cph_s
```


```{r Plot of Moderate calibration, +survivin}
# density plot included, 4-biomarker model

par(xaxs = "i", yaxs = "i", las = 1)
plot(
  dat_cal_s$pred, 
  dat_cal_s$obs,
  type = "l", 
  lty = 1, 
  xlim = c(0, 1),
  ylim = c(0, 1), 
  lwd = 2,
  xlab = "Predicted risk from developed model",
  ylab = "Predicted risk from refitted model", bty = "n"
)
lines(dat_cal_s$pred, 
      dat_cal_s$lower, 
      type = "l", 
      lty = 2, 
      lwd = 2)
lines(dat_cal_s$pred, 
      dat_cal_s$upper,
      type = "l", 
      lty = 2, 
      lwd = 2)
abline(0, 1, lwd = 2, lty = 2, col = 2)
legend("topleft",
        c("Ideal calibration",
          "Calibration curve based on secondary Cox model",
          "95% confidence interval"),
        col = c(2, 1, 1),
        lty = c(2, 1, 2),
        lwd = c(2, 2, 2),
        bty = "n",
        cex = 0.85)
# Add density at bottom
dens <- density(dat_cal_s$pred, from = 0, to = 1)
# Rescale density to fit in lower margin of plot
dens_y <- 0.2 * dens$y / max(dens$y)  # 5% height of y-axis range
lines(dens$x, dens_y, col = "grey40", lwd = 2)


```
```{r Moderate calibration, +survivin}
# Base plot
par(xaxs = "i", yaxs = "i", las = 1)
plot(
  dat_cal_s$pred, 
  dat_cal_s$obs,
  type = "l", 
  lty = 1, 
  xlim = c(0, 1),
  ylim = c(0, 1), 
  lwd = 2,
  xlab = "Predicted risk from 4-biomarker model",
  ylab = "Observed proportion", 
  bty = "n"
)

# Add shaded 95% CI using polygon
polygon(
  c(dat_cal_s$pred, rev(dat_cal_s$pred)),
  c(dat_cal_s$lower, rev(dat_cal_s$upper)),
  col = rgb(0, 0, 0, 0.15),  # Semi-transparent grey
  border = NA
)

# Add main calibration curve
lines(dat_cal_s$pred, dat_cal_s$obs, lty = 1, lwd = 2)

# Add reference line for ideal calibration
abline(0, 1, lwd = 2, lty = 2, col = 2)

# Add legend
legend("topleft",
       c("Ideal calibration",
         "Calibration curve based on secondary Cox model",
         "95% confidence interval"),
       col = c(2, 1, rgb(0, 0, 0, 0.15)),
       lty = c(2, 1, NA),
       lwd = c(2, 2, NA),
       pch = c(NA, NA, 15),
       pt.cex = 2,
       bty = "n",
       cex = 0.85)

# Add density at bottom
dens <- density(dat_cal_s$pred, from = 0, to = 1)
dens_y <- 0.2 * dens$y / max(dens$y)
lines(dens$x, dens_y, col = "grey40", lwd = 2)
box()
```


```{r Moderate calibration, -survivin}
# Base plot
par(xaxs = "i", yaxs = "i", las = 1)
plot(
  dat_cal_new$pred, 
  dat_cal_new$obs,
  type = "l", 
  lty = 1, 
  xlim = c(0, 1),
  ylim = c(0, 1), 
  lwd = 2,
  xlab = "Predicted risk from three-biomarker model",
  ylab = "Observed proportion", 
  bty = "n"
)

# Add shaded 95% CI using polygon
polygon(
  c(dat_cal_new$pred, rev(dat_cal_new$pred)),
  c(dat_cal_new$lower, rev(dat_cal_new$upper)),
  col = rgb(0, 0, 0, 0.15),  # Semi-transparent grey
  border = NA
)

# Add main calibration curve
lines(dat_cal_new$pred, dat_cal_new$obs, lty = 1, lwd = 2)

# Add reference line for ideal calibration
abline(0, 1, lwd = 2, lty = 2, col = 2)

# Add legend
legend("topleft",
       c("Ideal calibration",
         "Calibration curve based on secondary Cox model",
         "95% confidence interval"),
       col = c(2, 1, rgb(0, 0, 0, 0.15)),
       lty = c(2, 1, NA),
       lwd = c(2, 2, NA),
       pch = c(NA, NA, 15),
       pt.cex = 2,
       bty = "n",
       cex = 0.85)

# Add density at bottom
dens <- density(dat_cal_new$pred, from = 0, to = 1)
dens_y <- 0.2 * dens$y / max(dens$y)
lines(dens$x, dens_y, col = "grey40", lwd = 2)
box()
```


```{r Moderate calibration, -survivin}
if (!require("pacman")) install.packages("pacman")
library(pacman)
pacman::p_load(survival,
               Hmisc,
               rms)
# -survivin model

new_fit <- coxph(Surv(t.os, Outcome) ~ p16_binary + HPVISHHR + TILS,
  data = complete_training_data, 
  x = T, 
  y = T)

# curve:
val_5$pred_new <- riskRegression::predictRisk(new_fit, 
                         newdata = val_5, 
                         times = 5)

val_5$pred_new.cll <- log(-log(1 - val_5$pred_new))


# Estimate actual risk
vcal_new <- rms::cph(Surv(t.os, Outcome) ~ rcs(pred_new.cll, 3),
                 x = T,
                 y = T,
                 surv = T,
                 data = val_5
) 

dat_cal_new <- cbind.data.frame(
  "obs" = 1 - rms::survest(vcal_new,
                           times = 5,
                           newdata = val_5)$surv,
  
  "lower" = 1 - rms::survest(vcal_new,
                             times = 5,
                             newdata = val_5)$upper,
  
  "upper" = 1 - rms::survest(vcal_new,
                             times = 5,
                             newdata = val_5)$lower,
  "pred" = val_5$pred_new
)

dat_cal_new <- dat_cal_new[order(dat_cal_new$pred), ]


# Numerical measures
absdiff_cph_new <- abs(dat_cal_new$pred - dat_cal_new$obs)

numsum_cph_new <- c(
  "ICI" = mean(absdiff_cph_new),
  setNames(quantile(absdiff_cph_new, c(0.5, 0.9)), c("E50", "E90")),
  "Emax" = max(absdiff_cph_new)
)
numsum_cph_new

# ggplot version, 3-biomarker model
ggplot(dat_cal_new, aes(x = pred, y = obs)) +
  geom_line(aes(color = "Calibration curve", linetype = "Calibration curve"), linewidth = 1) +
  geom_line(aes(y = lower, color = "95% CI", linetype = "95% CI"), linewidth = 0.5) +
  geom_line(aes(y = upper, color = "95% CI", linetype = "95% CI"), linewidth = 0.5) +
  geom_abline(aes(intercept = 0, slope = 1, color = "Ideal calibration", linetype = "Ideal calibration"), 
              linewidth = 1) +
  scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  scale_color_manual(values = c("Calibration curve" = "black", 
                               "95% CI" = "black", 
                               "Ideal calibration" = "red")) +
  scale_linetype_manual(values = c("Calibration curve" = "solid", 
                                  "95% CI" = "dashed", 
                                  "Ideal calibration" = "dashed")) +
  labs(x = "Predicted 5-Year OS Risk (3-Biomarker Model)",
       y = "Observed 5-Year OS Risk",
       title = "Calibration Curve: 3-Biomarker Model") +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 8),
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(color = "black"),
        axis.line = element_line(color = "black")) +
  guides(color = guide_legend(override.aes = list(linewidth = c(1, 0.5, 1))))

```

#  Agreement between +survivin and -survivin models
```{r}

plot_data <- val_5 %>%
  select(pred_new, pred_survivin)

n <- nrow(plot_data)
r <- cor(plot_data$pred_survivin, plot_data$pred_new) # Pearson correlation = 0.976
# Fisher’s Z transformation
z <- atanh(r) # or 0.5 * log((1 + r) / (1 - r))
se_z <- 1 / sqrt(n - 3)
z_lower <- z - qnorm(0.975) * se_z # 1.96 for 95% CI
z_upper <- z + qnorm(0.975) * se_z

# Transform back to correlation scale
r_lower <- tanh(z_lower) # or (exp(2 * z_lower) - 1) / (exp(2 * z_lower) + 1)
r_upper <- tanh(z_upper)

# Print 95% CI
cat("Pearson correlation (95% CI):", round(r,3), ", (", round(r_lower, 3), "-", round(r_upper, 3), ")", "\n")


```


# PPV, NPV, sensitivity for 4-biomarker model

```{r}

# Four-biomarker model

eval_data <- val_5 %>%
  mutate(true_label = ifelse(Outcome == 1 & t.os <5, 1, 0))

table(eval_data$true_label)
table(eval_data$risk_group)

TP <- sum(eval_data$risk_group == 1 & eval_data$true_label == 1)
FP <- sum(eval_data$risk_group == 1 & eval_data$true_label == 0)
TN <- sum(eval_data$risk_group == 0 & eval_data$true_label == 0)
FN <- sum(eval_data$risk_group == 0 & eval_data$true_label == 1)

sensitivity <- TP / (TP + FN)
PPV <- TP / (TP + FP)
NPV <- TN / (TN + FN)

# 95% CIs
compute_metrics <- function(data) {
  TP <- sum(data$risk_group == 1 & data$true_label == 1)
  FP <- sum(data$risk_group == 1 & data$true_label == 0)
  TN <- sum(data$risk_group == 0 & data$true_label == 0)
  FN <- sum(data$risk_group == 0 & data$true_label == 1)
  
  sensitivity <- ifelse((TP + FN) == 0, NA, TP / (TP + FN))
  PPV <- ifelse((TP + FP) == 0, NA, TP / (TP + FP))
  NPV <- ifelse((TN + FN) == 0, NA, TN / (TN + FN))
  
  return(c(sensitivity = sensitivity, PPV = PPV, NPV = NPV))
}

set.seed(123)  # for reproducibility
n_boot <- 1000
boot_metrics <- replicate(n_boot, {
  boot_sample <- eval_data[sample(1:nrow(eval_data), replace = TRUE), ]
  compute_metrics(boot_sample)
})
boot_metrics_df <- as.data.frame(t(boot_metrics))

# 95% CI using percentiles of 4-biomarker model
ci_results <- apply(boot_metrics_df, 2, function(x) quantile(x, probs = c(0.025, 0.975), na.rm = TRUE))
ci_results
cat("Four-biomarker model:", "\n", 
    "Sensitivity: ", sensitivity,"(",ci_results[1,1], "," ,ci_results[2,1], ")", "\n", 
    "PPV:", PPV, "(",ci_results[1,2], "," ,ci_results[2,2], ")", "\n", 
    "NPV:", NPV, "(", ci_results[1,3], "," ,ci_results[2,3], ")" )


```
# PPV, NPV, sensitivity for 3-biomarker model
```{r}
# Three-biomarker model

eval_data <- val_5 %>%
  mutate(true_label = ifelse(Outcome == 1 & t.os <=5, 1, 0))

table(eval_data$true_label)
table(eval_data$risk_group_new)

TP <- sum(eval_data$risk_group_new == 1 & eval_data$true_label == 1)
FP <- sum(eval_data$risk_group_new == 1 & eval_data$true_label == 0)
TN <- sum(eval_data$risk_group_new == 0 & eval_data$true_label == 0)
FN <- sum(eval_data$risk_group_new == 0 & eval_data$true_label == 1)

sensitivity <- TP / (TP + FN)
PPV <- TP / (TP + FP)
NPV <- TN / (TN + FN)

compute_metrics_new <- function(data) {
  TP <- sum(data$risk_group_new == 1 & data$true_label == 1)
  FP <- sum(data$risk_group_new == 1 & data$true_label == 0)
  TN <- sum(data$risk_group_new == 0 & data$true_label == 0)
  FN <- sum(data$risk_group_new == 0 & data$true_label == 1)
  
  sensitivity <- ifelse((TP + FN) == 0, NA, TP / (TP + FN))
  PPV <- ifelse((TP + FP) == 0, NA, TP / (TP + FP))
  NPV <- ifelse((TN + FN) == 0, NA, TN / (TN + FN))
  
  return(c(sensitivity = sensitivity, PPV = PPV, NPV = NPV))
}

set.seed(123)  # for reproducibility
n_boot <- 1000
boot_metrics <- replicate(n_boot, {
  boot_sample <- eval_data[sample(1:nrow(eval_data), replace = TRUE), ]
  compute_metrics_new(boot_sample)
})
boot_metrics_df <- as.data.frame(t(boot_metrics))

# 95% CI using percentiles of 3-biomarker model
ci_results <- apply(boot_metrics_df, 2, function(x) quantile(x, probs = c(0.025, 0.975), na.rm = TRUE))

cat("Three-biomarker model:", "\n", 
    "Sensitivity: ", sensitivity,"(",ci_results[1,1], "," ,ci_results[2,1], ")", "\n", 
    "PPV:", PPV, "(",ci_results[1,2], "," ,ci_results[2,2], ")", "\n", 
    "NPV:", NPV, "(", ci_results[1,3], "," ,ci_results[2,3], ")" )


```
```{r}

eval_data <- val_5 %>%
  mutate(true_label = ifelse(Outcome == 1 & t.os <5, 1, 0))

table(eval_data$true_label)
table(eval_data$risk_group)

TP <- sum(eval_data$risk_group_new == 1 & eval_data$true_label == 1)
FP <- sum(eval_data$risk_group_new == 1 & eval_data$true_label == 0)
TN <- sum(eval_data$risk_group_new == 0 & eval_data$true_label == 0)
FN <- sum(eval_data$risk_group_new == 0 & eval_data$true_label == 1)

sensitivity <- TP / (TP + FN)
PPV <- TP / (TP + FP)
NPV <- TN / (TN + FN)

# 95% CIs
compute_metrics <- function(data) {
  TP <- sum(data$risk_group_new == 1 & data$true_label == 1)
  FP <- sum(data$risk_group_new == 1 & data$true_label == 0)
  TN <- sum(data$risk_group_nwe == 0 & data$true_label == 0)
  FN <- sum(data$risk_group_new == 0 & data$true_label == 1)
  
  sensitivity <- ifelse((TP + FN) == 0, NA, TP / (TP + FN))
  PPV <- ifelse((TP + FP) == 0, NA, TP / (TP + FP))
  NPV <- ifelse((TN + FN) == 0, NA, TN / (TN + FN))
  
  return(c(sensitivity = sensitivity, PPV = PPV, NPV = NPV))
}

set.seed(123)  # for reproducibility
n_boot <- 1000
boot_metrics <- replicate(n_boot, {
  boot_sample <- eval_data[sample(1:nrow(eval_data), replace = TRUE), ]
  compute_metrics(boot_sample)
})
boot_metrics_df <- as.data.frame(t(boot_metrics))

# 95% CI using percentiles of 4-biomarker model
ci_results <- apply(boot_metrics_df, 2, function(x) quantile(x, probs = c(0.025, 0.975), na.rm = TRUE))
ci_results
cat("Three-biomarker model:", "\n", 
    "Sensitivity: ", sensitivity,"(",ci_results[1,1], "," ,ci_results[2,1], ")", "\n", 
    "PPV:", PPV, "(",ci_results[1,2], "," ,ci_results[2,2], ")", "\n", 
    "NPV:", NPV, "(", ci_results[1,3], "," ,ci_results[2,3], ")" )

```



# Brier score - recommended overall performance measure
Brier score is the mean squared difference between observed event indicators and predicted risks at a fixed time point (5y here); lower is better
Scaled Brier score, aka Index of Prediction Accuracy (IPA) scales the Brier score (decrease in Brier vs. null model). Expressed as percentage; higher is better.
```{r Brier score and IPA, 5 y}
library(pacman)
pacman::p_load(survival,
               Hmisc,
               riskRegression,
               BuyseTest)

# Fit the 4-biomarker model
s_fit <- coxph(Surv(t.os, Outcome) ~ Survivin + p16_binary + HPVISHHR + TILS,
  data = complete_training_data, 
  x = T, 
  y = T)
# Fit the 3-biomarker model
new_fit <- coxph(Surv(t.os, Outcome) ~ p16_binary + HPVISHHR + TILS,
  data = complete_training_data, 
  x = T, 
  y = T)

# Fit null model (Kaplan-Meier equivalent)
null_fit <- coxph(Surv(t.os, Outcome) ~ 1, data = complete_training_data, 
                  x = TRUE, y = TRUE)

# Brier Score and IPA in the validation set (+survivin model)

score_s <- brier(s_fit, times = c(5), newdata = val_5)
# Original model Brier scores = 0.220 (5y)
score_n <- brier(new_fit, times = c(10), newdata = val_10)
#New model Brier scores = 0.221 (5y)


# IPA:
library(SurvMetrics)
library(BuyseTest)
surv_prob_null <- predictSurvProb(null_fit, newdata = val_5, times = times)

# Calculate Brier scores
brier_s <- SurvMetrics::Brier(surv_obj, pre_sp = surv_prob_s, t_star = times)
brier_new <- SurvMetrics::Brier(surv_obj, pre_sp = surv_prob_new, t_star = times)
brier_null <- SurvMetrics::Brier(surv_obj, pre_sp = surv_prob_null, t_star = times)

# Calculate IPA
ipa_s <- 1 - brier_s / brier_null
ipa_new <- 1 - brier_new / brier_null

# Store results
data_metrics <- data.frame(
  Model = c("4-Biomarker", "3-Biomarker", "Null"),
  Brier = c(brier_s, brier_new, brier_null),
  IPA = c(ipa_s, ipa_new, NA) # IPA not applicable for null model
)

# Print results
cat("Brier Scores and IPA:\n")
data_metrics

# 4-biomarker: Brier = 0.220; IPA = 0.095 = 9.5%
# 3-biomarker: Brier = 0.221; IPA = 0.094 = 9.4%
# BRIER SCORE 95% CI
set.seed(123)
n_boot <- 1000
brier_boot <- numeric(n_boot)
t_star <- 4.99
fit_model <- new_fit


for (i in 1:n_boot) {
  # Bootstrap sample
  idx <- sample(nrow(val_5), replace = TRUE)
  val_boot <- val_5[idx, ]
  surv_obj_boot <- with(val_boot, Surv(t.os, Outcome))
  
  # Predicted survival probability for the bootstrap sample
  surv_prob_boot <- predictSurvProb(fit_model, newdata = val_boot, times = t_star)
  
  # Brier score
  brier_boot[i] <- SurvMetrics::Brier(surv_obj_boot, pre_sp = surv_prob_boot, t_star = t_star)
}

# Calculate 95% CI
brier_ci <- quantile(brier_boot, probs = c(0.025, 0.975))

cat("Brier Score (95% CI):\n")
print(brier_ci)
```


```{r IPA 95% CI, 5 y}
####### IPA 95% CI ######

set.seed(2024)
n_boot <- 1000
ipa_boot <- numeric(n_boot)
fit_model <- s_fit
for (i in 1:n_boot) {
  # Bootstrap sample
  idx <- sample(nrow(val_5), replace = TRUE)
  val_boot <- val_5[idx, ]
  
  # Outcome object
  surv_obj_boot <- with(val_boot, Surv(t.os, Outcome))
  
  # Predicted survival probabilities at time `times`
  sp_new_boot <- predictSurvProb(fit_model, newdata = val_boot, times = times)
  sp_null_boot <- predictSurvProb(null_fit, newdata = val_boot, times = times)

  # Compute Brier scores
  brier_new_boot <- SurvMetrics::Brier(surv_obj_boot, pre_sp = sp_new_boot, t_star = times)
  brier_null_boot <- SurvMetrics::Brier(surv_obj_boot, pre_sp = sp_null_boot, t_star = times)
  
  # IPA
  ipa_boot[i] <- 1 - brier_new_boot / brier_null_boot
}

# 95% CI
ipa_ci <- quantile(ipa_boot, probs = c(0.025, 0.975))

cat("95% CI for IPA (3-Biomarker model):\n")
print(ipa_ci)



```

# Likelihood ratio test
```{r}
library(pacman)
pacman::p_load(lmtest)
#Training data:
summary(s_fit)
summary(new_fit)
lrtest(s_fit, new_fit)

# Val data (for generalizability):
s_fit_val <- coxph(Surv(t.os, Outcome) ~ p16_binary + Survivin + HPVISHHR + TILS,
  data = test_val_data, 
  x = T, 
  y = T)

new_fit_val <- coxph(Surv(t.os, Outcome) ~ p16_binary + HPVISHHR + TILS,
  data = test_val_data, 
  x = T, 
  y = T)

lrtest(s_fit_val, new_fit_val)

# Extract log-likelihoods
loglik_reduced <- logLik(new_fit)
loglik_full <- logLik(s_fit)

test_statistic <- -2 * (loglik_reduced[1] - loglik_full[1])
df <-  (length(s_fit$coefficients) - length(new_fit$coefficients))

p_value <- 1 - pchisq(test_statistic, df)

# Print the results
print(paste("Test statistic:", test_statistic))
print(paste("Degrees of freedom:", df))
print(paste("P-value:", p_value))
```




## Surgery vs no surgery in high-risk and low-risk patient groups, validation cohort
Also adjusting for age at diagnosis, then the clinical variables
```{r}
summary(test_val_data$Surgery) #total: 212. Paper (Fig 3C): 221
table_risk_surgery <- table(Risk_group = test_val_data$risk_group_new, Surgery = test_val_data$Surgery); print(table_risk_surgery)
ls0 <- table_risk_surgery[1,1]; ls1 <- table_risk_surgery[1,2]; hs0 <- table_risk_surgery[2,1]; hs1 <- table_risk_surgery[2,2]

#Split into the risk+surgery groups:
val_data_ls0 <- test_val_data[(test_val_data$Surgery == 0 & test_val_data$risk_group_new == 0),]
val_data_ls1 <- test_val_data[(test_val_data$Surgery == 1 & test_val_data$risk_group_new == 0),]
val_data_hs0 <- test_val_data[(test_val_data$Surgery == 0 & test_val_data$risk_group_new == 1),]
val_data_hs1 <- test_val_data[(test_val_data$Surgery == 1 & test_val_data$risk_group_new == 1),]


table(val_data_ls0$Smoking.status)
table(val_data_ls1$Smoking.status)
table(val_data_ls0$HPVISHHR)
table(val_data_ls1$HPVISHHR)

table(val_data_hs0$Smoking.status)
table(val_data_hs1$Smoking.status)
table(val_data_hs0$HPVISHHR)
table(val_data_hs1$HPVISHHR)


library(survminer)

#Create combined group factor
test_val_data$risk_surgery <- factor(
  paste0(

    ifelse(test_val_data$risk_group_new==0, "l", "h"),
    ifelse(test_val_data$Surgery == 0, "s0", "s1")

  ),
  levels = c("ls0", "ls1", "hs0", "hs1")
)

#Kaplan-Meier
surv_obj <- Surv(test_val_data$t.os, test_val_data$Outcome)

surv_fit <- survfit(surv_obj ~ risk_surgery, data = test_val_data)

ggsurv <- ggsurvplot(
  surv_fit,
  data = test_val_data,
  palette = c("blue", "green", "red", "purple"),
  risk.table = FALSE,
  title = "Training set - Three-Biomarker Model: Survival by Combined Risk Group and Surgery Status",
  xlab = "Time (years)",
  ylab = "Survival Probability",
  legend.title = "Group",
  legend.labs = c("Low, Surgery-", "Low, Surgery+", "High, Surgery-", "High, Surgery+"),
  conf.int = FALSE,
  pval = FALSE,
  xlim = c(0, 4.99),  # Up to 5 years
  break.time.by = 1
)
print(ggsurv)

# change this based on dataset and whether 3- or 4-biomarker model
low_data <- test_val_data[test_val_data$risk_group_new == 0, ]
high_data <- test_val_data[test_val_data$risk_group_new == 1, ]


low_cox <- coxph(Surv(t.os, Outcome) ~ Surgery, data = low_data)
low_summary <- summary(low_cox)
low_summary
# Low-risk group HR: 0.78 (0.35 - 1.72), log-rank P = 0.54
low_hr <- low_summary$coefficients["Surgery1", "exp(coef)"]
low_ci <- exp(low_summary$coefficients["Surgery1", "coef"] + c(-1.96, 1.96) * low_summary$coefficients["Surgery1", "se(coef)"])
low_p <- low_summary$coefficients["Surgery1", "Pr(>|z|)"]

low_hr
low_ci
low_p


high_cox <- coxph(Surv(t.os, Outcome) ~ Surgery, data = high_data)
high_summary <- summary(high_cox)
high_summary
high_hr <- high_summary$coefficients["Surgery1", "exp(coef)"]
high_ci <- exp(high_summary$coefficients["Surgery1", "coef"] + c(-1.96, 1.96) * high_summary$coefficients["Surgery1", "se(coef)"])
high_p <- high_summary$coefficients["Surgery1", "Pr(>|z|)"]

#High-risk group: surgery vs non surgery
# HR = 0.42 (0.25-0.70), log-rank P < 0.001
high_hr
high_ci
high_p

# Adjusting for year of diagnosis:
# Fit 3-biomarker Cox model + Age.at.Diagnosis
adj_new_model <- fit_cox_model(complete_training_data, c("p16_binary", "HPVISHHR", "TILS", "Age.at.Diagnosis"))
# Calculate median with training set:
complete_training_data$risk_score_new_adj <- predict(adj_new_model, complete_training_data, type = "lp")
summary(complete_training_data$risk_score_new_adj)

ggplot(complete_training_data, aes(x = risk_score_new_adj)) +
  geom_histogram(aes(y = after_stat(density), fill = "Original"), alpha = 0.5, bins = 100) +
  geom_histogram(aes(x = risk_score_new, y = after_stat(density), fill = "New"), alpha = 0.5, bins = 100) +
  labs(title = "Histogram of Risk Scores",
       x = "Risk Score",
       y = "Density",
       fill = "Score Type") +
  theme_minimal()

risk_med_cutoff_new_adj <- median(complete_training_data$risk_score_new_adj)

#Validation data: calculate risk scores

test_val_data$risk_score_new_adj <- predict(adj_new_model, test_val_data, type = "lp")
summary(test_val_data$risk_score_new_adj)

# Classify into risk groups:
test_val_data$risk_group_new_adj <- ifelse(test_val_data$risk_score_new > risk_med_cutoff_new_adj, 1, 0)

# Split into surgery +/- groups and calculate HR:

table_risk_surgery <- table(Risk_group = test_val_data$risk_group_new_adj, Surgery = test_val_data$Surgery); print(table_risk_surgery)
ls0 <- table_risk_surgery[1,1]; ls1 <- table_risk_surgery[1,2]; hs0 <- table_risk_surgery[2,1]; hs1 <- table_risk_surgery[2,2]

#Split into the risk+surgery groups:
val_data_ls0 <- test_val_data[(test_val_data$Surgery == 0 & test_val_data$risk_group_new_adj == 0),]
val_data_ls1 <- test_val_data[(test_val_data$Surgery == 1 & test_val_data$risk_group_new_adj == 0),]
val_data_hs0 <- test_val_data[(test_val_data$Surgery == 0 & test_val_data$risk_group_new_adj == 1),]
val_data_hs1 <- test_val_data[(test_val_data$Surgery == 1 & test_val_data$risk_group_new_adj == 1),]

# change this based on dataset and whether 3- or 4-biomarker model
low_data <- test_val_data[test_val_data$risk_group_new_adj == 0, ]
high_data <- test_val_data[test_val_data$risk_group_new_adj == 1, ]

# Calculate HRs
low_cox <- coxph(Surv(t.os, Outcome) ~ Surgery, data = low_data)
low_summary <- summary(low_cox)
low_summary
# Low-risk group HR: 0.78 (0.35 - 1.72), log-rank P = 0.54
low_hr <- low_summary$coefficients["Surgery1", "exp(coef)"]
low_ci <- exp(low_summary$coefficients["Surgery1", "coef"] + c(-1.96, 1.96) * low_summary$coefficients["Surgery1", "se(coef)"])
low_p <- low_summary$coefficients["Surgery1", "Pr(>|z|)"]

low_hr
low_ci
low_p


high_cox <- coxph(Surv(t.os, Outcome) ~ Surgery, data = high_data)
high_summary <- summary(high_cox)
high_summary
high_hr <- high_summary$coefficients["Surgery1", "exp(coef)"]
high_ci <- exp(high_summary$coefficients["Surgery1", "coef"] + c(-1.96, 1.96) * high_summary$coefficients["Surgery1", "se(coef)"])
high_p <- high_summary$coefficients["Surgery1", "Pr(>|z|)"]

#High-risk group: surgery vs non surgery
# HR = 0.42 (0.25-0.70), log-rank P < 0.001
high_hr
high_ci
high_p
## Findings: Highly similar when adjusted for Age.at.Diagnosis.
```


```{r Propensity score matching: 3-biomarker model}
########################
# Adjusting to address potential treatment selection bias
library(MatchIt)
library(survival)
# High risk:
# Matching on Age.at.Diagnosis, Smoking.status, T, and N
high.m.out <- matchit(
  Surgery ~ Age.at.Diagnosis + Smoking.status + T + N,
  data = high_data,
  method = "full",
  distance = "glm"
)
# Extracting matched data with weights
high_matched_data <- match.data(high.m.out)

# Fit weighted model
high_psm_model <- coxph(Surv(t.os, Outcome) ~ Surgery,
                   data = high_matched_data,
                   weights = weights)

summary(high_psm_model)
summary(high_psm_model)$sctest["pvalue"]
# High risk group -surgery vs +surgery: HR = 0.31 (0.18 - 0.55), p < 0.001

# Low risk:
# Matching on Age.at.Diagnosis, Smoking.status, T, and N
low.m.out <- matchit(
  Surgery ~ Age.at.Diagnosis + Smoking.status + T + N,
  data = low_data,
  method = "full",
  distance = "glm"
)
# Extracting matched data with weights
low_matched_data <- match.data(low.m.out)

# Fit weighted model
low_psm_model <- coxph(Surv(t.os, Outcome) ~ Surgery,
                   data = low_matched_data,
                   weights = weights)

summary(low_psm_model)$sctest["pvalue"]

# Low risk group -surgery vs +surgery: HR = 0.66 (0.18 - 2.43), logrank P = 0.322


```

## Surgery vs no surgery in low-risk and high-risk pts, training cohort
Aims:
- Address the +surgery vs -surgery finding: "In the validation cohort, the model was predictive of improved survival following treatment with surgery and CT over CRT alone for high-risk patients... but was not statistically significant in the low-risk patients."
- In the high (and maybe low-) risk group, compare the 3-year and 5-year OS for those who receive surgery vs those who did not. Find:
1. HR (95% CI) of high-risk surgery + adjuvant treatment vs. high-risk CRT
2. HR (95% CI) of low-risk surgery + adjuvant treatment vs. low-risk CRT
 -> Repeat, adjusting for year of diagnosis
 -> Repeat, adjusting for propensity score based on T, N, smoking status, and age at diagnosis.
3. Generate a survival plot of all 4 groups (surgery status x risk group) for old and new models

```{r Surgery, 3-biomarker, training set}
library(survminer)

# Table of Surgery status by Risk group assignment from the 3-biomarker model:
table_risk_surgery0 <- table(Risk_group = complete_training_data$risk_group_new, Surgery = complete_training_data$Surgery); print(table_risk_surgery0)

#l = low-risk, h = high-risk
#s0 = no surgery, s1 = surgery

ls0 <- table_risk_surgery0[1,1]; ls1 <- table_risk_surgery0[1,2]; hs0 <- table_risk_surgery0[2,1]; hs1 <- table_risk_surgery0[2,2]

#Split training data into their risk/surgery groups:
train_data_ls0 <- complete_training_data[(complete_training_data$Surgery == 0 & complete_training_data$risk_group == 0),]
train_data_ls1 <- complete_training_data[(complete_training_data$Surgery == 1 & complete_training_data$risk_group == 0),]
train_data_hs0 <- complete_training_data[(complete_training_data$Surgery == 0 & complete_training_data$risk_group == 1),]
train_data_hs1 <- complete_training_data[(complete_training_data$Surgery == 1 & complete_training_data$risk_group == 1),]


#Create combined group factor
complete_training_data$risk_surgery_new <- factor(
  paste0(

    ifelse(complete_training_data$risk_group_new==0, "l", "h"),
    ifelse(complete_training_data$Surgery == 0, "s0", "s1")

  ),
  levels = c("ls0", "ls1", "hs0", "hs1")
)

#Kaplan-Meier
surv_obj0 <- Surv(complete_training_data$t.os, complete_training_data$Outcome)

surv_fit0 <- survfit(surv_obj0 ~ risk_surgery_new, data = complete_training_data)

str(complete_training_data$risk_surgery_new)

table(complete_training_data$risk_surgery_new)
#K-M plot
ggsurv <- ggsurvplot(
  surv_fit0,
  data = complete_training_data,
  palette = c("blue", "green", "red", "purple"),
  risk.table = FALSE,
  title = "Training set - Three-Biomarker Model: Survival by Combined Risk Group and Surgery Status",
  xlab = "Time (years)",
  ylab = "Survival Probability",
  legend.title = "Group",
  legend.labs = c("Low, Surgery-", "Low, Surgery+", "High, Surgery-", "High, Surgery+"),
  conf.int = FALSE,
  pval = FALSE,
  xlim = c(0, 4.99),  # Up to 5 years
  break.time.by = 1
)
print(ggsurv)


low_data <- complete_training_data[complete_training_data$risk_group_new == 0, ]
low_cox <- coxph(Surv(t.os, Outcome) ~ Surgery, data = low_data)
low_summary <- summary(low_cox)
low_summary
# Overall Cox PH model HR (for surgery+ vs surgery- in low risk group): 0.17 (0.05 - 0.59), log-rank P = 0.002

high_data <- complete_training_data[complete_training_data$risk_group_new == 1, ]
high_cox <- coxph(Surv(t.os, Outcome) ~ Surgery, data = high_data)
high_summary <- summary(high_cox)
high_summary
# Overall Cox PH model HR (for surgery+ vs surgery- in high risk group): 0.55 (0.30 - 1.00), log-rank P = 0.05

#K-M 3-year OS

```
# surgery+/- in new model, validation set
```{r Surgery, 3-biomarker, validation set}
library(survminer)

# Table of Surgery status by Risk group assignment from the 3-biomarker model:

table_risk_surgery0 <- table(Risk_group = complete_training_data$risk_group_new, Surgery = complete_training_data$Surgery); print(table_risk_surgery0)

#l = low-risk, h = high-risk
#s0 = no surgery, s1 = surgery

ls0 <- table_risk_surgery0[1,1]; ls1 <- table_risk_surgery0[1,2]; hs0 <- table_risk_surgery0[2,1]; hs1 <- table_risk_surgery0[2,2]

#Split training data into their risk/surgery groups:
train_data_ls0 <- complete_training_data[(complete_training_data$Surgery == 0 & complete_training_data$risk_group == 0),]
train_data_ls1 <- complete_training_data[(complete_training_data$Surgery == 1 & complete_training_data$risk_group == 0),]
train_data_hs0 <- complete_training_data[(complete_training_data$Surgery == 0 & complete_training_data$risk_group == 1),]
train_data_hs1 <- complete_training_data[(complete_training_data$Surgery == 1 & complete_training_data$risk_group == 1),]


#Create combined group factor
complete_training_data$risk_surgery_new <- factor(
  paste0(

    ifelse(complete_training_data$risk_group_new==0, "l", "h"),
    ifelse(complete_training_data$Surgery == 0, "s0", "s1")

  ),
  levels = c("ls0", "ls1", "hs0", "hs1")
)

#Kaplan-Meier
surv_obj0 <- Surv(complete_training_data$t.os, complete_training_data$Outcome)

surv_fit0 <- survfit(surv_obj0 ~ risk_surgery_new, data = complete_training_data)

str(complete_training_data$risk_surgery_new)

table(complete_training_data$risk_surgery_new)

ggsurv <- ggsurvplot(
  surv_fit0,
  data = complete_training_data,
  palette = c("blue", "green", "red", "purple"),
  risk.table = FALSE,
  title = "Training set - Three-Biomarker Model: Survival by Combined Risk Group and Surgery Status",
  xlab = "Time (years)",
  ylab = "Survival Probability",
  legend.title = "Group",
  legend.labs = c("Low, Surgery-", "Low, Surgery+", "High, Surgery-", "High, Surgery+"),
  conf.int = FALSE,
  pval = FALSE,
  xlim = c(0, 4.99),  # Up to 5 years
  break.time.by = 1
)
print(ggsurv)


low_data <- complete_training_data[complete_training_data$risk_group_new == 0, ]
low_cox <- coxph(Surv(t.os, Outcome) ~ Surgery, data = low_data)
low_summary <- summary(low_cox)
low_summary
# HR (for surgery+ vs surgery- in low risk group): 0.17 (0.05 - 0.59), log-rank P = 0.002

high_data <- complete_training_data[complete_training_data$risk_group_new == 1, ]
high_cox <- coxph(Surv(t.os, Outcome) ~ Surgery, data = high_data)
high_summary <- summary(high_cox)
high_summary
# HR (for surgery+ vs surgery- in high risk group): 0.55 (0.30 - 1.00), log-rank P = 0.05

```


# Attempted replication of 4-biomarker model 4-group plots
```{r Surgery, 4-biomarker}

# Table of Surgery status by Risk group assignment from the 4-biomarker model:
table_risk_surgery0 <- table(Risk_group = complete_training_data$risk_group, Surgery = complete_training_data$Surgery); print(table_risk_surgery0)

#l = low-risk, h = high-risk
#s0 = no surgery, s1 = surgery

ls0 <- table_risk_surgery0[1,1]; ls1 <- table_risk_surgery0[1,2]; hs0 <- table_risk_surgery0[2,1]; hs1 <- table_risk_surgery0[2,2]

#Split training data into their risk/surgery groups:
train_data_ls0 <- complete_training_data[(complete_training_data$Surgery == 0 & complete_training_data$risk_group == 0),]
train_data_ls1 <- complete_training_data[(complete_training_data$Surgery == 1 & complete_training_data$risk_group == 0),]
train_data_hs0 <- complete_training_data[(complete_training_data$Surgery == 0 & complete_training_data$risk_group == 1),]
train_data_hs1 <- complete_training_data[(complete_training_data$Surgery == 1 & complete_training_data$risk_group == 1),]


library(survminer)

#Create combined group factor
complete_training_data$risk_surgery <- factor(
  paste0(

    ifelse(complete_training_data$risk_group==0, "l", "h"),
    ifelse(complete_training_data$Surgery == 0, "s0", "s1")

  ),
  levels = c("ls0", "ls1", "hs0", "hs1")
)

#Kaplan-Meier
surv_obj0 <- Surv(complete_training_data$t.os, complete_training_data$Outcome)

surv_fit0 <- survfit(surv_obj0 ~ risk_surgery, data = complete_training_data)

str(complete_training_data$risk_surgery)
print(summary(surv_fit0))

table(complete_training_data$risk_surgery)

ggsurv <- ggsurvplot(
  surv_fit0,
  data = complete_training_data,
  palette = c("blue", "green", "red", "purple"),
  risk.table = FALSE,
  title = "Training set - Four-Biomarker Model: Survival by Combined Risk Group and Surgery Status",
  xlab = "Time (years)",
  ylab = "Survival Probability",
  legend.title = "Group",
  legend.labs = c("Low, Surgery-", "Low, Surgery+", "High, Surgery-", "High, Surgery+"),
  conf.int = FALSE,
  pval = FALSE,
  xlim = c(0, 4.99),  # Up to 5 years
  break.time.by = 1
)
print(ggsurv)


low_data <- complete_training_data[complete_training_data$risk_group == 0, ]
low_cox <- coxph(Surv(t.os, Outcome) ~ Surgery, data = low_data)
low_summary <- summary(low_cox)
low_summary
# HR (for surgery+ vs surgery- in low risk group): 0.23 (0.05 - 1.1), log-rank P = 0.04

high_data <- complete_training_data[complete_training_data$risk_group == 1, ]
high_cox <- coxph(Surv(t.os, Outcome) ~ Surgery, data = high_data)
high_summary <- summary(high_cox)
high_summary
# HR (for surgery+ vs surgery- in high risk group): 0.52 (0.30 - 0.92), log-rank P = 0.02


```


#DCA for clinical utility

```{r DCA}

if (!require("pacman")) install.packages("pacman")
library(pacman)
pacman::p_load(here, survival, Hmisc, rmda, ggscidca)

# Run the function to calculate the net benefit and the elements needed to develop decision curve analysis


t_horizon <- 5



# 4-biomarker model: sfit. 3-biomarker model: new_fit
# Predicted risks are stored in test_val_data$pred_risk_5y_survivin and test_val_data$pred_risk_5y, respectively

# Run decision curve analysis

# Validation data, 5-year
# 4-biomarker model

val_5_df <- as.data.frame(test_val_5)
dca_surv <- stdca(
  data = val_5_df, 
  outcome = "Outcome", 
  ttoutcome = "t.os",
  timepoint = 5, 
  predictors = "pred_risk_5y_survivin", 
  xstop = 1.0,
  ymin = -0.01, 
  graph = FALSE
)

# Decision curves plot

# Smoothing DCA
dca_surv_smooth <- smooth(dca_surv$net.benefit$pred
                           [!is.na(dca_surv$net.benefit$pred)],
                           twiceit = TRUE)
dca_surv_smooth <- c(dca_surv_smooth, 
                      rep(NA, sum(is.na(dca_surv$net.benefit$pred))))

par(xaxs = "i", yaxs = "i", las = 1)
plot(dca_surv$net.benefit$threshold,
  dca_surv_smooth,
  type = "l", 
  lwd = 1,
  lty = 1,
  xlab = "Threshold probability in %", 
  ylab = "Net Benefit",
  xlim = c(0, 1), 
  ylim = c(-0.10, 0.60), 
  bty = "n",
  cex.lab = 1.2, 
  cex.axis = 1,
  col = 4
)
lines(dca_surv$net.benefit$threshold, 
      dca_surv$net.benefit$none, 
      type = "l", 
      lwd = 1, 
      lty = 4,
      col = 8)
lines(dca_surv$net.benefit$threshold, 
      dca_surv$net.benefit$all, 
      type = "l", 
      lwd = 1, 
      col = 2)
legend("topright",
  c(
    "Treat All",
    "Four-biomarker model: P(recurren)",
    "Treat None"
  ),
  lty = c(1, 1, 1), 
  lwd = 1, 
  col = c(2, 4, 8),
  bty = "n"
)

# read off at 23% threshold
dca_surv$net.benefit[dca_surv$net.benefit$threshold == 0.23, ]





```

```{r DCA, 3-biomarker model}


# 4-biomarker model: sfit. 3-biomarker model: new_fit
# Predicted risks are stored in test_val_data$pred_risk_5y_survivin and test_val_data$pred_risk_5y, respectively

# Run decision curve analysis

# Validation data, 5-year
# 3-biomarker model

val_5_df <- as.data.frame(test_val_5)
dca_new <- stdca(
  data = val_5_df, 
  outcome = "Outcome", 
  ttoutcome = "t.os",
  timepoint = 5, 
  predictors = "pred_risk_5y", 
  xstop = 1.0,
  ymin = -0.01, 
  graph = FALSE
)

# Decision curves plot

# Smoothing DCA
dca_new_smooth <- smooth(dca_new$net.benefit$pred
                           [!is.na(dca_new$net.benefit$pred)],
                           twiceit = TRUE)
dca_new_smooth <- c(dca_new_smooth, 
                      rep(NA, sum(is.na(dca_new$net.benefit$pred))))

par(xaxs = "i", yaxs = "i", las = 1)
plot(dca_new$net.benefit$threshold,
  dca_new_smooth,
  type = "l", 
  lwd = 1,
  lty = 1,
  xlab = "Threshold probability in %", 
  ylab = "Net Benefit",
  xlim = c(0, 1), 
  ylim = c(-0.10, 0.60), 
  bty = "n",
  cex.lab = 1.2, 
  cex.axis = 1,
  col = 4
)
lines(dca_new$net.benefit$threshold, 
      dca_new$net.benefit$none, 
      type = "l", 
      lwd = 1, 
      lty = 1,
      col = 8)
lines(dca_new$net.benefit$threshold, 
      dca_new$net.benefit$all, 
      type = "l", 
      lwd = 1, 
      col = 2)
legend("topright",
  c(
    "Treat All",
    "Three-biomarker model)",
    "Treat None"
  ),
  lty = c(1, 1, 1), 
  lwd = 1, 
  col = c(2, 4, 8),
  bty = "n"
)

# read off at 23% threshold
dca_surv$net.benefit[dca_surv$net.benefit$threshold == 0.23, ]

summary(val_5_df$pred_risk_5y)
nrow(val_5_df)
```
```{r}
# Optional smoothing
# smooth_curve <- function(x) {
#   sm <- smooth(x[!is.na(x)], twiceit = TRUE)
#   c(sm, rep(NA, sum(is.na(x))))
# }
smooth_curve <- function(x, k = 5) {
  y <- x[!is.na(x)]
  sm <- stats::filter(y, rep(1/k, k), sides = 2)
  c(sm, rep(NA, length(x) - length(sm)))
}


surv_smooth <- smooth_curve(dca_surv$net.benefit$pred)
new_smooth <- smooth_curve(dca_new$net.benefit$pred)

# Plot combined curves
par(xaxs = "i", yaxs = "i", las = 1)
plot(dca_surv$net.benefit$threshold,
     surv_smooth,
     type = "l",
     lwd = 2,
     col = "blue",
     xlab = "Threshold probability",
     ylab = "Net Benefit",
     xlim = c(0, 1),
     ylim = c(-0.10, 0.60),
     bty = "n",
     cex.lab = 1.2,
     cex.axis = 1)

lines(dca_new$net.benefit$threshold,
      new_smooth,
      type = "l",
      lwd = 2,
      col = "darkgreen")

# Treat all and treat none (same in both models, pick one)
lines(dca_surv$net.benefit$threshold,
      dca_surv$net.benefit$all,
      type = "l",
      lwd = 1,
      lty = 2,
      col = "red")

lines(dca_surv$net.benefit$threshold,
      dca_surv$net.benefit$none,
      type = "l",
      lwd = 1,
      lty = 3,
      col = "black")

legend("topright",
       legend = c("4-biomarker model", "3-biomarker model", "Treat All", "Treat None"),
       col = c("blue", "darkgreen", "red", "black"),
       lty = c(1, 1, 2, 3),
       lwd = c(2, 2, 1, 1),
       bty = "n")

```

```{r Comparing decision curves with nbdiff}
# There are nine arguments in the ntbft() function:
# 
#     data: a data frame on which the prediction model is trained.
#     outcome: a character string indicting the name of the outcome or disease status.
#     frm: a formula in the form of outcome~predictor 1 + predictor 2, where each variable should be the contained in the data frame. The argument specifies the prediction model to be fitted in case the argument pred below is NULL (if the pred argument is provided, frm is not used).
#     exterdt: a data frame to specify whether the prediction should be made in external dataset; this is useful for cross validation of the model. By default, the value is NULL, indicating the prediction is made in the same dataset as the training dataset.
#     pred: a vector of predicted values to be used to calculate the net benefit. By default, the value is NULL, indicating that such predicted values should be calculated by the routine using the model specified by frm.
#     xstart: the starting point of the threshold probability, the default value is 0.01.
#     xstop: the end point of the threshold probability, the default value is 0.99.
#     step: a numerical value specifying the incremental step of the threshold probability, the default value is 0.01.
#     type: controls the type of net benefit to be computed. The allowed values correspond to the treated (“treated”), untreated (“untreated”) and overall (“overall”) patients, or to the ADAPT index (“adapt”). The default is the “treated”.

ntbft <- function(data, outcome, frm=NULL, exterdt=NULL, pred=NULL, xstart=0.01, xstop = 0.99, step=0.01, type = "treated") {
  
  pt <- seq(from=xstart, to=xstop, by=step)
  lpt <- length(pt)
  
  if(type == "treated")
    coef <- cbind(rep(1, lpt), rep(0, lpt))
  if(type == "untreated")
    coef <- cbind(rep(0, lpt), rep(1, lpt))
  if(type == "overall")
    coef <- cbind(rep(1, lpt), rep(1, lpt))
  if(type == "adapt")
    coef <- cbind(1-pt, pt)
  
  response <- as.vector(t(data[outcome]))
  if(is.data.frame(exterdt))
    response <- as.vector(t(exterdt[outcome]))
  event.rate <- mean(response)
  nball <- event.rate - (1-event.rate)*pt/(1-pt)
  nbnone <- 1-event.rate-event.rate*(1-pt)/pt
  
  if(is.null(pred)) {
    model <- glm(frm, data=data, family=binomial("logit"))
    pred <- model$fitted.values
  
  if(is.data.frame(exterdt))
    pred <- predict(model, newdata=exterdt, type = "response")
  }
  
  #pred and response should be of same length
  
  N <- length(pred)
  nbt <- rep(NA,lpt)
  nbu <- rep(NA, lpt)
  
  for(t in 1:lpt) {
    tp <- sum(pred>= pt[t] & response == 1)
    fp <- sum(pred>= pt[t] & response == 0)
    fn <- sum(pred < pt[t] & response == 1)
    tn <- sum(pred < pt[t] & response == 0)
    
    nbt[t] <- tp/N - fp/N*(pt[t]/(1-pt[t]))
    nbu[t] <- tn/N - fn/N*((1-pt[t])/pt[t])
  }
  
  nb <- data.frame(pt)
  names(nb) <- "threshold"
  nb["all"] <- -coef[,1]*nball
  nb["none"] <- -coef[,2]*nbnone
  nb["pred"] <- -coef[,1]*nbt + coef[,2]*nbu
  return(nb)
  
}


nbdiff <- function(data, ii, outcome, frml, frm2, xstart = 0.01, xstop = 0.99, step = 0.01, type = "treated") {
  
  dd <- data[ii,]
  nb1 <- ntbft(data = dd, outcome = outcome, frm = frm1, xstart=xstart, xstop = xstop, step = step, type = type)
  nb2 <- ntbft(data = dd, outcome = outcome, frm = frm2, xstart=xstart, xstop = xstop, step = step, type = type)
  
  nb.diff <- nb2$pred-nbl$pred
  cat(".")
  return(nb.diff)
  
}

model1 <- Outcome ~ p16_binary + Survivin + HPVISHHR + TILS
model2 <- Outcome ~ p16_binary + HPVISHHR + TILS

nb.survivin <- ntbft(data = val_5_df, outcome = "Outcome", frm = model1, pred = val_5_df$pred_risk_5y_survivin)
nb.new <- ntbft(data = val_5_df, outcome = "Outcome", frm = model2, pred = val_5_df$pred_risk_5y)

#Plot:

# There are six arguments in the plot.ntbft() function:
# 
#     nb: a data frame of net benefit, where the first column contains the threshold probabilities and the next columns contains the net benefit achieved for different models.
#     nolines: the number of the columns of nb which should be plotted using lines. The default is to plot all columns (except the first one containing the threshold).
#     nobands: the number of the columns of nb which should be plotted using bands (useful to plot confidence intervals). The default is to plot no bands.
#     ymin: the minimum of net benefit to be plotted. The default is −0.1.
#     ymax: the maximum of net benefit to be plotted. The default is the maximum of the net benefits which are plotted either via lines or via bands.
#     legpos: a vector of two coordinates indicating where the legend should be in the graph.



plot.ntbft <- function(nb, nolines = 2:dim(nb)[2], nobands = NULL, ymin = -0.5, ymax = max(nb[,c(nolines, nobands)], na.rm=T), legpos = c(0.9,0.8)) {
  
  ylow <- nb[,1]
  yup <- nb[,1]
  if(!is.null(nobands)){
    ylow <- nb[,min(nobands)]
    yup <- nb[,max(nobands)]
  }
  nb.melt <- melt(nb[,c(1, nolines)],
                  id.vars = "threshold",
                  value.name = "Netbenefit", variable.name = "Models"
                  )
  print(ggplot(nb.melt) +
          theme(legend.position.inside = legpos) +
          geom_line(aes(x=threshold, y = Netbenefit,
                        colour = Models,
                        linetype = Models)) +
          geom_ribbon(data=nb, aes(x=threshold,
                                   ymin = ylow,
                                   ymax = yup),
                      linetype = 2, alpha = 0.2) +
          scale_y_continuous(limits=c(ymin,ymax)) +
          xlab("Threshold probability") +
          ylab("Net benefit")
          
          )
}

library(ggplot2)
library(reshape2)
nb.survivin
names(nb)
nb <- cbind(nb.survivin, pred.new = nb.new$pred)
names(nb)[names(nb)=="pred"] <- "pred.survivin"

summary(nb)
head(nb)

plot.ntbft(nb)

```


